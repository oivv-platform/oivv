<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MePont | Community-Powered Fashion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito+Sans:wght@400;600;700&family=Playfair+Display:wght@400;500;600;700&display=swap" rel="stylesheet">
    
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'background': '#FDFDFD',
                        'primary': '#1C1C1C',
                        'secondary': '#6B6B6B',
                        'accent': '#004D40',
                        'accent-dark': '#00382e',
                        'subtle': '#F5F5F5',
                        'success': '#2E7D32',
                        'design': '#C7A4FF', // A soft lilac for the design stage
                        'sampling': '#FFC107' // A warm amber for sampling
                    },
                    fontFamily: {
                        'sans': ['Nunito Sans', 'sans-serif'],
                        'serif': ['Playfair Display', 'serif'],
                    },
                    transitionProperty: {
                        'transform': 'transform',
                    }
                }
            }
        }
    </script>

    <style>
        body {
            font-family: 'Nunito Sans', sans-serif;
            background-color: #FDFDFD;
            color: #1C1C1C;
        }
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }
        .cursor-grab { cursor: grab; }
        .cursor-grabbing { cursor: grabbing; }
        .blur-background { filter: blur(4px); transition: filter 0.3s ease-in-out; }
    </style>
</head>
<body class="bg-background text-primary">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;

        // --- EXPANDED MOCK DATA ---
        const MOCK_CAMPAIGNS = [
            { 
                id: 1, name: 'The Milano Linen Blazer', designer: 'Studio Rossi', price: 185, stage: 'PRE_ORDER', productionRound: 2, category: 'Outerwear', subCategory: 'Blazers', heroImage: 'https://images.unsplash.com/photo-1594938384914-29a4491a9599?q=80&w=800&auto=format&fit=crop', images: [ 'https://images.unsplash.com/photo-1594938384914-29a4491a9599?q=80&w=800&auto=format&fit=crop', 'https://images.unsplash.com/photo-1617137968427-4dd4bf633758?q=80&w=800&auto=format&fit=crop', 'https://images.unsplash.com/photo-1551028719-00167b16eac5?q=80&w=800&auto=format&fit=crop' ], video: {thumbnail: 'https://placehold.co/800x1000/64748b/ffffff?text=Video', url: 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4'}, details: 'Crafted from 100% organic Italian linen, this blazer offers a relaxed yet structured fit.', preOrderDetails: { fundingType: 'INDEPENDENT', daysLeft: 12, sizes: { 'S': { moq: 50, funded: 50 }, 'M': { moq: 100, funded: 98 }, 'L': { moq: 100, funded: 35 }, 'XL': { moq: 50, funded: 2 } } }, priceBreakdown: { materials: 70, manufacturing: 65, designer: 25, platform: 25 }, sizeGuide: { fitDetails: 'Relaxed, unstructured fit.', sizes: { 'S': { 'Chest': '38"', 'Sleeve': '25"', 'Length': '28"' }, 'M': { 'Chest': '40"', 'Sleeve': '25.5"', 'Length': '28.5"' }, 'L': { 'Chest': '42"', 'Sleeve': '26"', 'Length': '29"' } } }, comments: [{user: 'Julia S.', comment: 'So excited for Round 2!'}], reviews: [ { user: 'Alex R.', rating: 5, comment: 'The quality is absolutely insane for the price.'}, { user: 'Beatrice L.', rating: 4, comment: 'Beautiful blazer, though it runs a little large.'}, ], has3D: true, manufacturer: { name: 'Artisan Tailors Lda', country: 'Portugal' }, digitalPassport: { uniqueId: 'MEP-2025-0001', manufacturerInfo: { name: 'Artisan Tailors Lda', address: 'Rua das Flores 123, 4050-262 Porto, Portugal', contact: 'production@artisans.pt' }, supplyChain: [ { component: 'Main Fabric', material: '100% Organic Linen', supplier: 'Solbiati S.r.l.', origin: 'Emilia-Romagna, Italy' }, { component: 'Buttons', material: 'Natural Horn', supplier: 'Bottonificio Padano', origin: 'Parma, Italy' } ], sustainability: { recycledContent: '10%', durability: 'High', repairability: { score: '8/10', details: 'Spare buttons included.' }, endOfLife: { instructions: 'Fabric is biodegradable.', recyclable: true } }, compliance: { svhc: 'None', certifications: ['European FlaxÂ® Certified'] } }
            },
            { 
                id: 2, name: 'The Siena Silk Scarf', designer: 'Atelier Bianchi', price: 65, stage: 'DESIGN', likes: 82, targetLikes: 150, category: 'Accessories', subCategory: 'Scarves', heroImage: 'https://images.unsplash.com/photo-1529374255404-311a2a4f1fd9?q=80&w=800&auto=format&fit=crop', details: 'A beautifully printed silk scarf, designed to be the centerpiece of any outfit. Made from 100% Como silk.'
            },
            {
                id: 3, name: 'The Roma Trench Coat', designer: 'Sartoria Fontana', price: 350, stage: 'SAMPLING', samplingDaysLeft: 21, category: 'Outerwear', subCategory: 'Coats', heroImage: 'https://images.unsplash.com/photo-1542485236-343855b533a7?q=80&w=800&auto=format&fit=crop', details: 'A modern interpretation of the classic trench coat, crafted from water-resistant Italian cotton gabardine.'
            },
             { 
                id: 7, name: 'The Nomad Travel Shirt', designer: 'Wayfarer Co.', price: 95, stage: 'PRE_ORDER', productionRound: 1, category: 'Tops', subCategory: 'Shirts', heroImage: 'https://images.unsplash.com/photo-1603252109360-778ba9913158?q=80&w=800&auto=format&fit=crop', images: ['https://images.unsplash.com/photo-1603252109360-778ba9913158?q=80&w=800&auto=format&fit=crop'], details: 'The only shirt you need. Made from a technical merino wool blend that is wrinkle-resistant, anti-odor, and temperature regulating.', preOrderDetails: { fundingType: 'COMBINED', daysLeft: 18, overallMoq: 200, sizes: { 'S': { funded: 30 }, 'M': { funded: 65 }, 'L': { funded: 40 }, 'XL': { funded: 15 } } }, priceBreakdown: { materials: 35, manufacturing: 32, designer: 15, platform: 13 }, sizeGuide: { fitDetails: 'Modern athletic fit.', sizes: { 'S': { 'Chest': '38"' }, 'M': { 'Chest': '40"' }, 'L': { 'Chest': '42"'} } }, comments: [], reviews: [], has3D: false, manufacturer: { name: 'TechFabrics Vietnam', country: 'Vietnam' }, digitalPassport: { uniqueId: 'MEP-2025-0007', manufacturerInfo: { name: 'TechFabrics Vietnam Co., Ltd.', address: 'Lot 4, Tan Thuan EPZ, Ho Chi Minh City, Vietnam', contact: 'compliance@techfab.vn' }, supplyChain: [ { component: 'Main Fabric', material: '87% Merino Wool, 13% Nylon', supplier: 'Nippon Wool Co.', origin: 'Japan (Milling)' } ], sustainability: { recycledContent: 'None', durability: 'Excellent', repairability: { score: '6/10', details: 'Standard repairs possible.' }, endOfLife: { instructions: 'Recyclable.', recyclable: true } }, compliance: { svhc: 'None', certifications: ['Responsible Wool Standard (RWS)'] } }
            },
            {
                id: 4, name: 'The Capri Leather Belt', designer: 'Pelletteria Moretti', price: 80, stage: 'DESIGN', likes: 145, targetLikes: 200, category: 'Accessories', subCategory: 'Belts', heroImage: 'https://images.unsplash.com/photo-1620924409743-037372c43543?q=80&w=800&auto=format&fit=crop', details: 'A timeless leather belt, handcrafted from Tuscan vegetable-tanned leather with a solid brass buckle.'
            },
            {
                id: 5, name: 'The Florence Knit Sweater', designer: 'Maglificio Rossi', price: 150, stage: 'SAMPLING', samplingDaysLeft: 15, category: 'Knitwear', subCategory: 'Sweaters', heroImage: 'https://images.unsplash.com/photo-1616253330771-b1625c2a230c?q=80&w=800&auto=format&fit=crop', details: 'An exceptionally soft crewneck sweater, knitted in Florence from a luxurious blend of cashmere and merino wool.'
            },
        ];

        // --- SVG ICONS ---
        const PlusIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const MinusIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"></line></svg>;
        const PlayIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path d="M8 5v14l11-7z"></path></svg>;
        const CubeIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>;
        const HomeIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
        const UserIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const XIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const HeartIcon = ({ className, isFilled }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={isFilled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>;
        const StarIcon = ({ className, isFilled }) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill={isFilled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>;
        const FilterIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon></svg>;

        // --- MAIN APP COMPONENT ---
        function App() {
            const [currentScreen, setCurrentScreen] = useState('Home');
            const [campaigns, setCampaigns] = useState(MOCK_CAMPAIGNS);
            const [pledgedItems, setPledgedItems] = useState([MOCK_CAMPAIGNS[0]]); // Mock pledged item
            const [likedItems, setLikedItems] = useState([2, 4]); // Mock liked items
            const [waitlistItems, setWaitlistItems] = useState([3, 5]); // Mock waitlist items
            
            const [showPledgeModal, setShowPledgeModal] = useState(false);
            const [show3DModal, setShow3DModal] = useState(false);
            const [showMediaModal, setShowMediaModal] = useState({ visible: false, startIndex: 0 });
            const [showCampaignModal, setShowCampaignModal] = useState(null);
            const [showFilterMenu, setShowFilterMenu] = useState(false);

            const [filters, setFilters] = useState({ stages: [], categories: [] });

            const isModalOpen = showPledgeModal || show3DModal || showMediaModal.visible || !!showCampaignModal || showFilterMenu;
            const isNestedModalOpen = (!!showCampaignModal) && (showPledgeModal || show3DModal || showMediaModal.visible);
            
            const productionSteps = ['Funded', 'Fabric Sourced', 'In Production', 'Quality Check', 'Shipped'];
            useEffect(() => {
                const interval = setInterval(() => {
                    setPledgedItems(prevItems =>
                        prevItems.map(item => {
                            if (!item.productionStatus) item.productionStatus = 'Funded';
                            const currentStepIndex = productionSteps.indexOf(item.productionStatus);
                            if (currentStepIndex < productionSteps.length - 1 && Math.random() < 0.2) {
                                const nextStepIndex = currentStepIndex + 1;
                                return { ...item, productionStatus: productionSteps[nextStepIndex] };
                            }
                            return item;
                        })
                    );
                }, 5000); 

                return () => clearInterval(interval);
            }, []);

            const hasPurchased = (campaignId) => pledgedItems.some(item => item.id === campaignId);
            
            const navigateTo = (screen) => {
                setShowCampaignModal(null);
                setCurrentScreen(screen);
            }

            const viewCampaignDetail = (campaign) => {
                setShowCampaignModal(campaign);
            };
            
            const handleLikeToggle = (campaignId) => {
                setLikedItems(prev => prev.includes(campaignId) ? prev.filter(id => id !== campaignId) : [...prev, campaignId]);
            };

            const handleWaitlistToggle = (campaignId) => {
                setWaitlistItems(prev => prev.includes(campaignId) ? prev.filter(id => id !== campaignId) : [...prev, campaignId]);
            };

            const handlePledge = (campaign, size) => {
                const newPledge = { ...campaign, size, productionStatus: 'Funded' };
                setPledgedItems(prev => [...prev, newPledge]);
                setCampaigns(prevCampaigns =>
                    prevCampaigns.map(c => {
                        if (c.id === campaign.id && c.stage === 'PRE_ORDER') {
                            const updatedSizes = { ...c.preOrderDetails.sizes };
                            if(updatedSizes[size]) {
                                updatedSizes[size].funded += 1;
                            }
                            return { ...c, preOrderDetails: { ...c.preOrderDetails, sizes: updatedSizes }};
                        }
                        return c;
                    })
                );
                setShowPledgeModal(false);
            };
            
            const addComment = (campaignId, commentText) => {
                const newComment = { user: 'You', comment: commentText };
                setCampaigns(prev => prev.map(c => 
                    c.id === campaignId ? {...c, comments: [...(c.comments || []), newComment]} : c
                ));
            };
            
            const addReview = (campaignId, review) => {
                const newReview = { user: 'You', ...review };
                setCampaigns(prev => prev.map(c => 
                    c.id === campaignId ? {...c, reviews: [...(c.reviews || []), newReview]} : c
                ));
            };

            const filteredCampaigns = campaigns.filter(campaign => {
                const stageMatch = filters.stages.length === 0 || filters.stages.includes(campaign.stage);
                const categoryMatch = filters.categories.length === 0 || filters.categories.includes(campaign.subCategory);
                return stageMatch && categoryMatch;
            });

            const renderScreen = () => {
                switch (currentScreen) {
                case 'Home':
                    return <HomeScreen 
                                campaigns={filteredCampaigns} 
                                onCampaignSelect={viewCampaignDetail} 
                                onLikeToggle={handleLikeToggle} 
                                likedItems={likedItems}
                                onWaitlistToggle={handleWaitlistToggle}
                                waitlistItems={waitlistItems}
                                onShowFilters={() => setShowFilterMenu(true)}
                            />;
                case 'Dashboard':
                    const userLikedCampaigns = campaigns.filter(c => likedItems.includes(c.id));
                    const userWaitlistCampaigns = campaigns.filter(c => waitlistItems.includes(c.id));
                    return <DashboardScreen 
                                pledgedItems={pledgedItems} 
                                likedItems={userLikedCampaigns}
                                waitlistItems={userWaitlistCampaigns}
                                productionSteps={productionSteps} 
                            />;
                default:
                    return <HomeScreen campaigns={filteredCampaigns} onCampaignSelect={viewCampaignDetail} />;
                }
            };

            return (
                <div className="w-full min-h-screen font-sans">
                    <div className={isModalOpen ? 'blur-background' : ''}>
                        <div className="max-w-7xl mx-auto pb-16 sm:pb-0">
                            <TopNavBar onNavigate={navigateTo} />
                            <main>
                                {renderScreen()}
                            </main>
                        </div>
                    </div>

                    <BottomNavBar currentScreen={currentScreen} onNavigate={navigateTo} />
                    
                    {showFilterMenu && <FilterMenu onClose={() => setShowFilterMenu(false)} currentFilters={filters} onApplyFilters={setFilters} />}
                    
                    {showCampaignModal && 
                        <CampaignDetailModal 
                            campaign={showCampaignModal} 
                            onPledge={() => setShowPledgeModal(true)} 
                            onBack={() => setShowCampaignModal(null)}
                            onLikeToggle={handleLikeToggle}
                            isLiked={likedItems.includes(showCampaignModal.id)}
                            onWaitlistToggle={handleWaitlistToggle}
                            isWaitlisted={waitlistItems.includes(showCampaignModal.id)}
                            hasPurchased={hasPurchased(showCampaignModal.id)}
                            onCommentSubmit={addComment}
                            onReviewSubmit={addReview}
                            onShow3D={() => setShow3DModal(true)}
                            onShowMedia={(startIndex) => setShowMediaModal({ visible: true, startIndex })}
                            isNestedModalOpen={isNestedModalOpen}
                        />
                    }
                    {showPledgeModal && <PledgeModal campaign={showCampaignModal} onClose={() => setShowPledgeModal(false)} onPledge={handlePledge} />}
                    {show3DModal && <ThreeDModal onClose={() => setShow3DModal(false)} />}
                    {showMediaModal.visible && <MediaViewerModal campaign={showCampaignModal} startIndex={showMediaModal.startIndex} onClose={() => setShowMediaModal({ visible: false, startIndex: 0 })} />}
                </div>
            );
        }
        
        // --- SCREEN COMPONENTS ---

        function HomeScreen({ campaigns, onCampaignSelect, onLikeToggle, likedItems, onWaitlistToggle, waitlistItems, onShowFilters }) {
            return (
                <div>
                    <div className="p-4 sm:p-6 lg:p-8 text-center border-b border-subtle">
                        <h1 className="font-serif text-4xl sm:text-5xl font-medium tracking-normal text-primary">The Drops</h1>
                        <p className="mt-3 text-sm sm:text-base text-secondary max-w-2xl mx-auto">Fund the next generation of fashion. Like, pledge, and participate in a transparent production journey.</p>
                        <button onClick={onShowFilters} className="mt-6 flex items-center gap-2 mx-auto px-4 py-2 rounded-full text-xs font-semibold tracking-wider uppercase transition-colors whitespace-nowrap bg-subtle text-secondary hover:bg-gray-200">
                            <FilterIcon className="w-4 h-4" />
                            <span>Filter & Sort</span>
                        </button>
                    </div>
                    <div className="p-4 sm:p-6 lg:p-8">
                        <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-x-6 gap-y-10">
                            {campaigns.map(campaign => ( 
                                <CampaignCard 
                                    key={campaign.id} 
                                    campaign={campaign} 
                                    onSelect={onCampaignSelect} 
                                    onLikeToggle={onLikeToggle} 
                                    isLiked={likedItems.includes(campaign.id)}
                                    onWaitlistToggle={onWaitlistToggle}
                                    isWaitlisted={waitlistItems.includes(campaign.id)}
                                /> 
                            ))}
                        </div>
                    </div>
                </div>
            );
        };

        function DashboardScreen({ pledgedItems, likedItems, waitlistItems, productionSteps }) {
            const [activeTab, setActiveTab] = useState('Pledged');
            
            const renderContent = () => {
                switch(activeTab) {
                    case 'Pledged':
                        return pledgedItems.length > 0 ? (
                            <div className="space-y-6">
                                {pledgedItems.map((item, index) => (
                                    <div key={index} className="bg-white p-4 sm:p-6 rounded-lg border border-subtle">
                                        <div className="flex flex-col sm:flex-row items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-6 mb-4">
                                            <img src={item.heroImage} alt={item.name} className="w-24 h-32 object-cover rounded-md flex-shrink-0" />
                                            <div className="flex-grow">
                                                <p className="font-serif text-lg font-medium">{item.name}</p>
                                                <p className="text-sm text-secondary">Size: {item.size}</p>
                                                <p className="font-serif text-base text-primary mt-1">â¬{item.price}</p>
                                            </div>
                                        </div>
                                        <div>
                                            <h4 className="font-semibold mb-3 text-xs uppercase tracking-wider text-secondary">Production Status</h4>
                                            <div className="flex items-start justify-between">
                                                {productionSteps.map((step) => {
                                                    const currentStepIndex = productionSteps.indexOf(item.productionStatus);
                                                    const stepIndex = productionSteps.indexOf(step);
                                                    const isCompleted = stepIndex <= currentStepIndex;
                                                    return (
                                                        <div key={step} className="flex-1 flex flex-col items-center text-center">
                                                            <div className={`w-5 h-5 rounded-full flex items-center justify-center transition-colors border-2 ${isCompleted ? 'bg-accent border-accent' : 'bg-white border-subtle'}`}>
                                                                {isCompleted && <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>}
                                                            </div>
                                                            <p className={`text-xs mt-2 transition-colors w-16 ${isCompleted ? 'font-semibold text-primary' : 'text-secondary'}`}>{step}</p>
                                                        </div>
                                                    );
                                                })}
                                            </div>
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : <p className="text-center text-secondary py-10">You have no pledged items.</p>;
                    case 'Liked':
                         return likedItems.length > 0 ? (
                            <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                                {likedItems.map(item => (
                                    <div key={item.id} className="bg-white rounded-lg border border-subtle p-2">
                                        <img src={item.heroImage} alt={item.name} className="w-full h-48 object-cover rounded-md" />
                                        <p className="font-serif text-sm font-medium mt-2 truncate">{item.name}</p>
                                        <p className="text-xs text-secondary">{item.designer}</p>
                                    </div>
                                ))}
                            </div>
                        ) : <p className="text-center text-secondary py-10">You have not liked any designs yet.</p>;
                    case 'Waiting List':
                        return waitlistItems.length > 0 ? (
                             <div className="grid grid-cols-2 sm:grid-cols-3 lg:grid-cols-4 gap-4">
                                {waitlistItems.map(item => (
                                    <div key={item.id} className="bg-white rounded-lg border border-subtle p-2">
                                        <img src={item.heroImage} alt={item.name} className="w-full h-48 object-cover rounded-md" />
                                        <p className="font-serif text-sm font-medium mt-2 truncate">{item.name}</p>
                                        <p className="text-xs text-secondary">{item.designer}</p>
                                    </div>
                                ))}
                            </div>
                        ) : <p className="text-center text-secondary py-10">You are not on any waiting lists.</p>;
                    default: return null;
                }
            };
            
            return (
                <div className="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
                    <header className="mb-8">
                        <h1 className="font-serif text-3xl sm:text-4xl font-medium text-primary">My MePont</h1>
                        <p className="text-secondary text-sm mt-1">Track your participation in our design journey.</p>
                    </header>
                    <div className="border-b border-subtle mb-6">
                        <div className="flex space-x-4 sm:space-x-8">
                            {['Pledged', 'Liked', 'Waiting List'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`py-2 text-sm font-semibold transition-colors ${activeTab === tab ? 'text-primary border-b-2 border-primary' : 'text-secondary hover:text-primary'}`}>
                                    {tab}
                                </button>
                            ))}
                        </div>
                    </div>
                    {renderContent()}
                </div>
            );
        };
        
        // --- UI & MODAL COMPONENTS ---

        function FilterMenu({ onClose, currentFilters, onApplyFilters }) {
            const [show, setShow] = useState(false);
            const [localFilters, setLocalFilters] = useState(currentFilters);

            const subCategories = MOCK_CAMPAIGNS.reduce((acc, campaign) => {
                if (!acc[campaign.category]) acc[campaign.category] = [];
                if (!acc[campaign.category].includes(campaign.subCategory)) {
                    acc[campaign.category].push(campaign.subCategory);
                }
                return acc;
            }, {});

            useEffect(() => {
                const timer = setTimeout(() => setShow(true), 10);
                document.body.style.overflow = 'hidden';
                return () => {
                    clearTimeout(timer);
                    document.body.style.overflow = 'auto';
                };
            }, []);

            const handleClose = () => {
                setShow(false);
                setTimeout(onClose, 300);
            };

            const handleStageToggle = (stage) => {
                setLocalFilters(prev => {
                    const newStages = prev.stages.includes(stage)
                        ? prev.stages.filter(s => s !== stage)
                        : [...prev.stages, stage];
                    return { ...prev, stages: newStages };
                });
            };

            const handleCategoryToggle = (category) => {
                setLocalFilters(prev => {
                    const newCategories = prev.categories.includes(category)
                        ? prev.categories.filter(c => c !== category)
                        : [...prev.categories, category];
                    return { ...prev, categories: newCategories };
                });
            };

            const handleApply = () => {
                onApplyFilters(localFilters);
                handleClose();
            };
            
            const handleClear = () => {
                const clearedFilters = { stages: [], categories: [] };
                setLocalFilters(clearedFilters);
                onApplyFilters(clearedFilters);
                handleClose();
            }

            return (
                <div className={`fixed inset-0 z-50 transition-opacity duration-300 ${show ? 'bg-black/20' : 'opacity-0 pointer-events-none'}`} onClick={handleClose}>
                    <div className={`fixed inset-y-0 right-0 w-full max-w-sm bg-background shadow-2xl transform transition-transform duration-300 ease-in-out ${show ? 'translate-x-0' : 'translate-x-full'}`} onClick={e => e.stopPropagation()}>
                        <div className="flex flex-col h-full">
                            <div className="flex items-center justify-between p-6 border-b border-subtle">
                                <h2 className="font-serif text-2xl">Filter</h2>
                                <button onClick={handleClose} className="text-secondary hover:text-primary"><XIcon className="w-6 h-6" /></button>
                            </div>
                            <div className="flex-grow p-6 overflow-y-auto space-y-8">
                                <div>
                                    <h3 className="font-semibold text-sm mb-4">Stage</h3>
                                    <div className="space-y-2">
                                        {['DESIGN', 'SAMPLING', 'PRE_ORDER'].map(stage => (
                                            <label key={stage} className="flex items-center space-x-3 cursor-pointer">
                                                <input type="checkbox" checked={localFilters.stages.includes(stage)} onChange={() => handleStageToggle(stage)} className="h-4 w-4 rounded border-gray-300 text-accent focus:ring-accent" />
                                                <span className="text-sm">{stage.replace('_', ' ')}</span>
                                            </label>
                                        ))}
                                    </div>
                                </div>
                                <div>
                                    <h3 className="font-semibold text-sm mb-4">Category</h3>
                                    <div className="space-y-4">
                                        {Object.entries(subCategories).map(([mainCat, subs]) => (
                                            <div key={mainCat}>
                                                <h4 className="font-semibold text-xs uppercase tracking-wider text-secondary mb-2">{mainCat}</h4>
                                                <div className="space-y-2">
                                                    {subs.map(subCat => (
                                                        <label key={subCat} className="flex items-center space-x-3 cursor-pointer">
                                                            <input type="checkbox" checked={localFilters.categories.includes(subCat)} onChange={() => handleCategoryToggle(subCat)} className="h-4 w-4 rounded border-gray-300 text-accent focus:ring-accent" />
                                                            <span className="text-sm">{subCat}</span>
                                                        </label>
                                                    ))}
                                                </div>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </div>
                            <div className="p-6 border-t border-subtle flex items-center gap-4">
                                <button onClick={handleClear} className="flex-1 text-center text-sm font-semibold text-secondary hover:text-primary">Clear All</button>
                                <button onClick={handleApply} className="flex-1 text-center bg-accent text-white py-3 rounded-md text-sm font-semibold hover:bg-accent-dark">Apply</button>
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function CampaignCard({ campaign, onSelect, onLikeToggle, isLiked, onWaitlistToggle, isWaitlisted }) {
            const renderCardContent = () => {
                const commonContent = (
                    <>
                        <p className="text-xs text-secondary">{campaign.designer}</p>
                        <h3 className="font-serif text-lg font-medium truncate text-primary mt-0.5">{campaign.name}</h3>
                    </>
                );

                switch (campaign.stage) {
                    case 'DESIGN':
                        return (
                            <div className="p-3">
                                {commonContent}
                                <div className="flex justify-between items-center mt-2">
                                    <span className="text-xs text-secondary">{campaign.likes} / {campaign.targetLikes} Likes</span>
                                    <button onClick={(e) => { e.stopPropagation(); onLikeToggle(campaign.id); }} className={`p-1 rounded-full transition-colors ${isLiked ? 'text-design' : 'text-gray-300 hover:text-design'}`}>
                                        <HeartIcon className="w-5 h-5" isFilled={isLiked} />
                                    </button>
                                </div>
                                <div className="w-full bg-subtle rounded-full h-1.5 mt-2">
                                    <div className="bg-design h-1.5 rounded-full" style={{ width: `${(campaign.likes / campaign.targetLikes) * 100}%` }}></div>
                                </div>
                            </div>
                        );
                    case 'SAMPLING':
                        return (
                            <div className="p-3">
                                {commonContent}
                                <p className="text-xs text-secondary mt-2">Sample reveal in {campaign.samplingDaysLeft} days</p>
                                <button onClick={(e) => { e.stopPropagation(); onWaitlistToggle(campaign.id); }} className={`w-full mt-3 text-xs font-semibold py-2 rounded-md transition-colors ${isWaitlisted ? 'bg-sampling text-primary' : 'bg-subtle text-secondary hover:bg-gray-200'}`}>
                                    {isWaitlisted ? 'On Waiting List' : 'Join Waiting List'}
                                </button>
                            </div>
                        );
                    case 'PRE_ORDER':
                        const { fundingType, sizes, overallMoq, daysLeft } = campaign.preOrderDetails;
                        const CardStatus = () => {
                            if (fundingType === 'COMBINED') {
                                const totalFunded = Object.values(sizes).reduce((acc, size) => acc + size.funded, 0);
                                const fundProgress = overallMoq > 0 ? (totalFunded / overallMoq) * 100 : 0;
                                return (
                                    <>
                                        <div className="w-full bg-subtle rounded-full h-1.5">
                                            <div className="bg-accent h-1.5 rounded-full" style={{ width: `${fundProgress}%` }}></div>
                                        </div>
                                        <div className="flex justify-between text-xs text-secondary mt-2">
                                            <span>{Math.floor(fundProgress)}% Funded</span>
                                            <span>{daysLeft} days left</span>
                                        </div>
                                    </>
                                );
                            } else {
                                const fundedSizes = Object.values(sizes).filter(s => s.funded >= s.moq).length;
                                const totalSizes = Object.keys(sizes).length;
                                return (
                                    <>
                                        <div className="w-full bg-subtle rounded-full h-1.5">
                                             <div className="bg-success h-1.5 rounded-full" style={{ width: `${(fundedSizes / totalSizes) * 100}%` }}></div>
                                        </div>
                                        <div className="flex justify-between text-xs text-secondary mt-2">
                                            <span className="font-medium">{fundedSizes} of {totalSizes} sizes funded</span>
                                            <span>{daysLeft} days left</span>
                                        </div>
                                    </>
                                );
                            }
                        };
                        return (
                            <div className="p-3">
                                {commonContent}
                                <div className="flex justify-between items-center mt-2">
                                    <span className="font-serif text-base text-primary">â¬{campaign.price}</span>
                                </div>
                                <div className="mt-3">
                                    <CardStatus />
                                </div>
                            </div>
                        );
                    default: return null;
                }
            };

            const stageColors = {
                DESIGN: 'bg-design text-primary',
                SAMPLING: 'bg-sampling text-primary',
                PRE_ORDER: 'bg-accent text-white'
            };

            return (
                <div onClick={() => onSelect(campaign)} className="bg-white rounded-lg overflow-hidden cursor-pointer transition-all duration-300 hover:shadow-lg border border-subtle group">
                    <div className="h-80 relative">
                        <img src={campaign.heroImage} alt={campaign.name} className="w-full h-full object-cover" />
                        <div className={`absolute top-3 right-3 backdrop-blur-sm text-xs font-semibold px-2 py-1 rounded-md shadow-sm ${stageColors[campaign.stage]}`}>
                            <span>{campaign.stage.replace('_', ' ')}</span>
                        </div>
                        {campaign.productionRound && (
                            <div className="absolute bottom-3 left-3 bg-white/90 backdrop-blur-sm text-xs font-bold px-2 py-1 rounded-md shadow-sm text-primary">
                                Round {campaign.productionRound}
                            </div>
                        )}
                    </div>
                    {renderCardContent()}
                </div>
            );
        };
        
        // --- NAVIGATION & MODAL COMPONENTS ---

        function TopNavBar({ onNavigate }) {
            return (
                <header className="bg-background/80 backdrop-blur-sm border-b border-subtle sticky top-0 z-40">
                    <nav className="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
                        <div className="flex justify-between items-center h-16">
                            <div className="flex-shrink-0">
                                <button onClick={() => onNavigate('Home')} className="font-serif text-2xl font-medium text-primary">MePont</button>
                            </div>
                            <div className="hidden sm:block sm:ml-6">
                                <div className="flex space-x-4">
                                    <button onClick={() => onNavigate('Home')} className="text-secondary hover:text-primary px-3 py-2 rounded-md text-sm font-medium">Drops</button>
                                    <button onClick={() => onNavigate('Dashboard')} className="text-secondary hover:text-primary px-3 py-2 rounded-md text-sm font-medium">My MePont</button>
                                </div>
                            </div>
                        </div>
                    </nav>
                </header>
            );
        }

        function BottomNavBar({ currentScreen, onNavigate }) {
            return (
                <div className="sm:hidden bg-background/90 backdrop-blur-sm border-t border-subtle flex justify-around p-2 fixed bottom-0 w-full z-40 h-16">
                    <button onClick={() => onNavigate('Home')} className={`flex flex-col items-center justify-center space-y-1 p-2 rounded-lg w-full transition-colors ${currentScreen === 'Home' ? 'text-primary' : 'text-secondary'}`}>
                        <HomeIcon className="w-5 h-5" />
                        <span className="text-xs font-semibold">Drops</span>
                    </button>
                    <button onClick={() => onNavigate('Dashboard')} className={`flex flex-col items-center justify-center space-y-1 p-2 rounded-lg w-full transition-colors ${currentScreen === 'Dashboard' ? 'text-primary' : 'text-secondary'}`}>
                        <UserIcon className="w-5 h-5" />
                        <span className="text-xs font-semibold">My MePont</span>
                    </button>
                </div>
            );
        };
        
        const AccordionItem = ({ title, children, isOpen, onToggle }) => {
            return (
                <div className="border-b border-subtle">
                    <button onClick={onToggle} className="w-full flex justify-between items-center py-4 text-left">
                        <span className="font-semibold text-sm text-primary">{title}</span>
                        {isOpen ? <MinusIcon className="w-4 h-4 text-secondary" /> : <PlusIcon className="w-4 h-4 text-secondary" />}
                    </button>
                    {isOpen && (
                        <div className="pb-4 text-xs text-secondary leading-relaxed">
                            {children}
                        </div>
                    )}
                </div>
            );
        };

        function CampaignDetailModal({ campaign, onPledge, onBack, onLikeToggle, isLiked, onWaitlistToggle, isWaitlisted, hasPurchased, onCommentSubmit, onReviewSubmit, onShow3D, onShowMedia, isNestedModalOpen }) {
            const [show, setShow] = useState(false);
            
            useEffect(() => {
                const timer = setTimeout(() => setShow(true), 10);
                document.body.style.overflow = 'hidden';
                return () => {
                    clearTimeout(timer);
                    document.body.style.overflow = 'auto';
                };
            }, []);

            const handleClose = () => {
                setShow(false);
                setTimeout(onBack, 300);
            };
            
            return (
                <div 
                    className={`fixed top-0 left-0 right-0 bottom-16 sm:inset-0 z-50 flex items-center justify-center p-0 sm:p-4 lg:p-8 transition-opacity duration-300 ease-in-out ${show ? 'opacity-100' : 'opacity-0'}`} 
                    onClick={handleClose}
                >
                    <div 
                        className={`w-full h-full bg-background/80 backdrop-blur-xl shadow-2xl transform transition-all duration-300 ease-in-out relative overflow-hidden sm:rounded-2xl ${show ? 'scale-100 opacity-100' : 'scale-95 opacity-0'} ${isNestedModalOpen ? 'blur-background' : ''}`}
                        onClick={(e) => e.stopPropagation()}
                    >
                        <button onClick={handleClose} className="absolute top-4 right-4 text-secondary bg-white/50 rounded-full p-2 hover:bg-white z-20">
                            <XIcon className="w-5 h-5" />
                        </button>
                        <div className="w-full h-full overflow-y-auto scrollbar-hide">
                           <CampaignDetailContent {...{campaign, onPledge, onBack, onLikeToggle, isLiked, onWaitlistToggle, isWaitlisted, hasPurchased, onCommentSubmit, onReviewSubmit, onShow3D, onShowMedia}} />
                        </div>
                    </div>
                </div>
            );
        };
        
        function CampaignDetailContent({ campaign, onPledge, onLikeToggle, isLiked, onWaitlistToggle, isWaitlisted, hasPurchased, onCommentSubmit, onReviewSubmit, onShow3D, onShowMedia }) {
            const [activeTab, setActiveTab] = useState('Details');
            const [openAccordion, setOpenAccordion] = useState(null);
            
            const mediaItems = [ ...[...new Set([campaign.heroImage, ...(campaign.images || [])])].map(img => ({ type: 'image', url: img, thumbnail: img })), ...(campaign.video ? [{ type: 'video', url: campaign.video.url, thumbnail: campaign.video.thumbnail }] : []) ];
            const [currentMediaIndex, setCurrentMediaIndex] = useState(0);
            
            const touchStartX = useRef(0);
            const touchEndX = useRef(0);
            const hasSwiped = useRef(false);

            const handleTouchStart = (e) => {
                touchStartX.current = e.targetTouches[0].clientX;
                hasSwiped.current = false;
            };
            const handleTouchMove = (e) => {
                touchEndX.current = e.targetTouches[0].clientX;
                if (Math.abs(touchStartX.current - touchEndX.current) > 10) {
                    hasSwiped.current = true;
                }
            };
            const handleTouchEnd = () => {
                if (!hasSwiped.current) return;
                const swipeDistance = touchStartX.current - touchEndX.current;
                if (Math.abs(swipeDistance) > 50) {
                    const direction = swipeDistance > 0 ? 1 : -1;
                    const newIndex = Math.max(0, Math.min(currentMediaIndex + direction, mediaItems.length - 1));
                    setCurrentMediaIndex(newIndex);
                }
            };
            
            const handleMediaClick = (index) => {
                if (!hasSwiped.current) {
                    onShowMedia(index);
                }
            };
            
            const handleAccordionToggle = (title) => {
                setOpenAccordion(openAccordion === title ? null : title);
            };

            const DetailsPanel = () => (
                <div className="bg-transparent">
                    <div className="p-5 lg:p-6 border-b border-subtle">
                        <p className="text-xs uppercase tracking-widest text-secondary">{campaign.designer}</p>
                        <h2 className="font-serif text-3xl lg:text-4xl font-medium text-primary mt-1">{campaign.name}</h2>
                    </div>
                    
                    {renderTopSection()}
                    
                    <div className="px-5 lg:px-6 pb-5">
                        <div className="flex border-b border-subtle overflow-x-auto scrollbar-hide">
                            {['Details', 'Price Breakdown', 'Size & Fit', 'Community'].map(tab => (
                                <button key={tab} onClick={() => setActiveTab(tab)} className={`py-3 px-4 text-xs font-semibold uppercase tracking-wider whitespace-nowrap transition-colors ${activeTab === tab ? 'border-b-2 border-primary text-primary' : 'text-secondary hover:text-primary'}`}>
                                    {tab}
                                </button>
                            ))}
                        </div>
                        <div className="py-4">
                            {renderTabContent()}
                        </div>
                    </div>
                </div>
            );

            const renderTabContent = () => {
                const { digitalPassport, manufacturer, sizeGuide, priceBreakdown, reviews, comments } = campaign;
                const [selectedSize, setSelectedSize] = useState(sizeGuide ? Object.keys(sizeGuide.sizes)[0] : null);
                const euCountries = ["Portugal", "Spain", "France", "Italy", "Germany"];
                const isEU = manufacturer && euCountries.includes(manufacturer.country);

                switch(activeTab) {
                    case 'Details': return (
                        <div>
                            <p className="text-secondary mb-6 text-sm leading-relaxed">{campaign.details}</p>
                            
                            {isEU && (
                                <div className="mb-6 bg-subtle p-4 rounded-lg flex items-center gap-4">
                                    <div className="w-6 h-4 bg-blue-800 rounded-sm"></div>
                                    <div>
                                        <h4 className="font-bold text-primary text-sm">Proudly Made in the EU</h4>
                                        <p className="text-xs text-secondary mt-1">This product is manufactured in {manufacturer.country}.</p>
                                    </div>
                                </div>
                            )}
                            
                            {digitalPassport && Object.entries(digitalPassport).map(([key, value]) => {
                                let title = key.replace(/([A-Z])/g, ' $1').replace(/^./, str => str.toUpperCase());
                                if (key === 'manufacturerInfo') title = 'Manufacturer & Origin';
                                if (key === 'supplyChain') title = 'Supply Chain Traceability';
                                if (key === 'sustainability') title = 'Sustainability & Circularity';
                                if (key === 'compliance') title = 'Compliance & Certifications';
                                
                                return (
                                    <AccordionItem key={key} title={title} isOpen={openAccordion === key} onToggle={() => handleAccordionToggle(key)}>
                                        {/* Simplified content for brevity */}
                                        <pre className="text-xs whitespace-pre-wrap">{JSON.stringify(value, null, 2)}</pre>
                                    </AccordionItem>
                                )
                            })}
                        </div>
                    );
                    case 'Price Breakdown': 
                        if (!priceBreakdown) return <p className="text-secondary text-sm">Price breakdown not available.</p>;
                        const totalCost = Object.values(priceBreakdown).reduce((sum, val) => sum + val, 0); 
                        return ( <div> <p className="text-secondary mb-4 text-sm">We believe in radical transparency. Here's the true cost of making this garment.</p> <div className="space-y-3 mb-6"> {Object.entries(priceBreakdown).map(([key, value]) => { const percentage = (totalCost > 0 ? (value / totalCost) * 100 : 0); return ( <div key={key}> <div className="flex justify-between text-xs mb-1"> <span className="capitalize text-secondary">{key}</span> <span className="font-semibold text-primary">â¬{value.toFixed(2)}</span> </div> <div className="w-full bg-subtle rounded-full h-1.5"> <div className="bg-accent h-1.5 rounded-full" style={{width: `${percentage}%`}}></div> </div> </div> ) })} </div> <div className="border-t border-subtle pt-4"> <div className="flex justify-between text-sm mb-2"> <span className="text-secondary">True Cost</span> <span className="font-serif font-medium text-primary">â¬{totalCost.toFixed(2)}</span> </div> <div className="flex justify-between text-base font-bold text-primary"> <span className="font-sans">Our Price</span> <span className="font-serif font-medium text-lg">â¬{campaign.price.toFixed(2)}</span> </div> </div> <div className="mt-6 bg-subtle p-3 rounded-lg text-xs text-secondary"> <p><strong>Please Note:</strong> The final price at checkout will include an estimate for shipping and any applicable import duties based on your delivery address. This will be clearly displayed before you confirm your pledge.</p> </div> </div> );
                    case 'Size & Fit': 
                        if (!sizeGuide) return <p className="text-secondary text-sm">Size guide not available.</p>;
                        return ( <div> <p className="text-secondary mb-4 text-sm">{sizeGuide.fitDetails}</p> <div className="flex space-x-2 mb-4 overflow-x-auto pb-2 scrollbar-hide"> {Object.keys(sizeGuide.sizes).map(size => ( <button key={size} onClick={() => setSelectedSize(size)} className={`px-4 py-2 rounded-md border transition-all text-xs font-semibold ${selectedSize === size ? 'bg-primary text-white border-primary' : 'bg-white text-secondary border-subtle'}`}> {size} </button> ))} </div> <div className="bg-subtle p-4 rounded-lg space-y-2 text-xs"> <h5 className="font-bold mb-2 text-primary">Measurements for Size {selectedSize}</h5> {Object.entries(sizeGuide.sizes[selectedSize]).map(([key, value]) => ( <div key={key} className="flex justify-between"> <span className="text-secondary">{key}</span> <span className="font-semibold text-primary">{value}</span> </div> ))} </div> </div> );
                    case 'Community': return ( <div className="space-y-8"> <div> <h4 className="font-serif font-medium text-lg mb-3 text-primary">Reviews</h4> {reviews && reviews.length > 0 ? ( <div className="space-y-4"> {reviews.map((review, index) => ( <div key={index} className="border-b border-subtle pb-4"> <div className="flex items-center mb-2"> {[...Array(5)].map((_, i) => <StarIcon key={i} className="w-4 h-4 text-accent" isFilled={i < review.rating} />)} <span className="ml-3 font-bold text-sm text-primary">{review.user}</span> </div> <p className="text-secondary text-sm">{review.comment}</p> </div> ))} </div> ) : ( <p className="text-secondary text-sm py-2">No reviews yet.</p> )} {hasPurchased && <ReviewForm campaignId={campaign.id} onSubmit={onReviewSubmit} />} </div> <div> <h4 className="font-serif font-medium text-lg mb-3 text-primary">Comments</h4> {comments && comments.length > 0 ? ( <div className="space-y-4"> {comments.map((comment, index) => ( <div key={index} className="border-b border-subtle pb-4"> <p className="font-bold text-sm text-primary">{comment.user}</p> <p className="text-secondary text-sm mt-1">{comment.comment}</p> </div> ))} </div> ) : ( <p className="text-secondary text-sm py-2">No comments yet. Be the first!</p> )} <CommentForm campaignId={campaign.id} onSubmit={onCommentSubmit} /> </div> </div> );
                    default: return null;
                }
            };
            
            const renderTopSection = () => {
                const actionButtonClass = "font-semibold py-3 rounded-md transition-all flex items-center justify-center text-sm";
                
                const MainActions = () => {
                    switch(campaign.stage) {
                        case 'DESIGN':
                             return (
                                <button onClick={() => onLikeToggle(campaign.id)} className={`w-full mt-4 ${actionButtonClass} ${isLiked ? 'bg-design text-primary' : 'border border-design text-design'}`}>
                                    <HeartIcon className="w-5 h-5 mr-2" isFilled={isLiked} />
                                    <span>{isLiked ? 'Liked' : 'Like to Fund Sampling'}</span>
                                </button>
                            );
                        case 'SAMPLING':
                            return (
                                <button onClick={() => onWaitlistToggle(campaign.id)} className={`w-full mt-4 ${actionButtonClass} ${isWaitlisted ? 'bg-sampling text-primary' : 'border border-sampling text-amber-600'}`}>
                                    {isWaitlisted ? 'On Waiting List' : 'Join Waiting List'}
                                </button>
                            );
                        case 'PRE_ORDER': 
                            return (
                                <div className="flex items-stretch gap-3 mt-4">
                                    <button onClick={onPledge} className={`flex-grow ${actionButtonClass} bg-accent text-white hover:bg-accent-dark`}>
                                        Pledge Now for <span className="font-serif ml-1.5">â¬{campaign.price}</span>
                                    </button>
                                    <div className="flex items-center justify-center text-sm font-bold text-primary bg-subtle px-4 rounded-md whitespace-nowrap">
                                        R{campaign.productionRound}
                                    </div>
                                </div>
                            );
                        default: return null;
                    }
                }

                return (
                    <div className="p-5 lg:p-6 border-b border-subtle">
                        {campaign.stage === 'DESIGN' && (
                            <>
                                <div className="w-full bg-subtle rounded-full h-1.5"> <div className="bg-design h-1.5 rounded-full" style={{ width: `${(campaign.likes / campaign.targetLikes) * 100}%` }}></div> </div>
                                <div className="flex justify-between items-center text-xs text-secondary mt-2"> <span>{campaign.likes} / {campaign.targetLikes} likes to fund sampling</span></div>
                            </>
                        )}
                        {campaign.stage === 'SAMPLING' && (
                            <div className="text-center bg-subtle p-4 rounded-lg">
                                <p className="font-semibold text-sm text-primary">Sample in Progress</p>
                                <p className="text-xs text-secondary">Reveal in {campaign.samplingDaysLeft} days</p>
                            </div>
                        )}
                        {campaign.stage === 'PRE_ORDER' && ( campaign.preOrderDetails.fundingType === 'COMBINED' ? ( <> <div className="w-full bg-subtle rounded-full h-1.5"> <div className="bg-accent h-1.5 rounded-full" style={{ width: `${(Object.values(campaign.preOrderDetails.sizes).reduce((acc, size) => acc + size.funded, 0) / campaign.preOrderDetails.overallMoq) * 100}%` }}></div> </div> <div className="flex justify-between items-center text-xs text-secondary mt-2"> <span>{Object.values(campaign.preOrderDetails.sizes).reduce((acc, size) => acc + size.funded, 0)} / {campaign.preOrderDetails.overallMoq} Funded</span> <span className="font-semibold">{campaign.preOrderDetails.daysLeft} days left</span> </div> </> ) : ( <> <div className="flex justify-between items-center text-sm text-secondary mb-4"> <span className="font-semibold">Funding Ends in {campaign.preOrderDetails.daysLeft} days</span> <span className="font-serif font-medium text-lg text-primary">â¬{campaign.price}</span> </div> <div className="space-y-3 mb-4"> <h4 className="font-semibold text-xs text-primary">Fund each size independently:</h4> {Object.entries(campaign.preOrderDetails.sizes).map(([size, data]) => { const progress = (data.funded / data.moq) * 100; const isFunded = progress >= 100; return ( <div key={size}> <div className={`flex justify-between items-center mb-1 text-xs ${isFunded ? 'text-success font-semibold' : 'text-secondary'}`}> <span className="font-semibold">{size}</span> <span>{data.funded} / {data.moq}</span> </div> <div className="w-full bg-subtle rounded-full h-1.5"> <div className={`${isFunded ? 'bg-success' : 'bg-accent'} h-1.5 rounded-full`} style={{ width: `${Math.min(progress, 100)}%` }}></div> </div> </div> ); })} </div> </> ) )}
                        
                        <MainActions />
                    </div>
                );
            };

            return (
                <div className="w-full h-full pt-12 md:pt-0">
                    <div className="hidden lg:grid lg:grid-cols-5 w-full h-full">
                        <div className="lg:col-span-3 h-full p-4 flex gap-4">
                            <div className="flex flex-col space-y-2 pt-1 overflow-y-auto scrollbar-hide">
                                {mediaItems.map((media, index) => (
                                    <button key={index} onClick={() => setCurrentMediaIndex(index)} className={`w-16 h-20 flex-shrink-0 rounded-md overflow-hidden border-2 relative ${currentMediaIndex === index ? 'border-accent' : 'border-transparent'}`}>
                                        <img src={media.thumbnail} alt={media.type} className="w-full h-full object-cover" />
                                        {media.type === 'video' && <div className="absolute inset-0 bg-black/30 flex items-center justify-center"><PlayIcon className="w-6 h-6 text-white" /></div>}
                                    </button>
                                ))}
                            </div>
                            <div className="relative flex-1 h-full">
                                <button className="w-full h-full rounded-lg overflow-hidden" onClick={() => onShowMedia(currentMediaIndex)}>
                                    {mediaItems[currentMediaIndex].type === 'video' ? (
                                        <video key={mediaItems[currentMediaIndex].url} src={mediaItems[currentMediaIndex].url} autoPlay loop muted playsInline className="w-full h-full object-cover bg-subtle"></video>
                                    ) : (
                                        <img src={mediaItems[currentMediaIndex].url} alt="Product view" className="w-full h-full object-cover" />
                                    )}
                                </button>
                                {campaign.has3D && (
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); onShow3D(); }} 
                                        className="absolute bottom-4 right-4 bg-white/80 backdrop-blur-sm text-primary font-semibold py-2 px-3 rounded-full flex items-center gap-2 text-xs hover:bg-white transition-colors"
                                    >
                                        <CubeIcon className="w-4 h-4" />
                                        <span>3D</span>
                                    </button>
                                )}
                            </div>
                        </div>
                        <div className="lg:col-span-2 h-full overflow-y-auto scrollbar-hide border-l border-subtle">
                           <DetailsPanel />
                        </div>
                    </div>
                    <div className="lg:hidden w-full h-full">
                        <DetailsPanel />
                        <div className="mb-6 px-4 pt-4 pb-4">
                            <div 
                                className="relative aspect-[4/5] mb-2"
                                onTouchStart={handleTouchStart}
                                onTouchMove={handleTouchMove}
                                onTouchEnd={handleTouchEnd}
                            >
                                <button className="w-full h-full" onClick={() => handleMediaClick(currentMediaIndex)}>
                                {mediaItems[currentMediaIndex].type === 'video' ? (
                                    <video key={mediaItems[currentMediaIndex].url} src={mediaItems[currentMediaIndex].url} controls className="w-full h-full object-cover rounded-lg shadow-sm bg-subtle"></video>
                                ) : (
                                    <img src={mediaItems[currentMediaIndex].url} alt="Product view" className="w-full h-full object-cover rounded-lg shadow-sm" />
                                )}
                                </button>
                                {campaign.has3D && (
                                    <button 
                                        onClick={(e) => { e.stopPropagation(); onShow3D(); }} 
                                        className="absolute bottom-3 right-3 bg-white/80 backdrop-blur-sm text-primary font-semibold py-1 px-2 rounded-full flex items-center gap-1.5 text-xs hover:bg-white transition-colors"
                                    >
                                        <CubeIcon className="w-4 h-4" />
                                        <span>3D</span>
                                    </button>
                                )}
                            </div>
                            <div className="flex justify-center items-center space-x-1.5">
                                {mediaItems.map((_, index) => (
                                    <div key={index} className={`w-1.5 h-1.5 rounded-full transition-colors ${currentMediaIndex === index ? 'bg-primary' : 'bg-gray-300'}`}></div>
                                ))}
                            </div>
                        </div>
                    </div>
                </div>
            );
        };
        
        function CommentForm({ campaignId, onSubmit }) {
            const [comment, setComment] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if(comment.trim()) {
                    onSubmit(campaignId, comment);
                    setComment('');
                }
            }
            return (
                <form onSubmit={handleSubmit} className="mt-4">
                    <textarea value={comment} onChange={(e) => setComment(e.target.value)} className="w-full p-2 border border-subtle rounded-md text-sm bg-white focus:outline-none focus:ring-1 focus:ring-accent" placeholder="Add a comment..."></textarea>
                    <button type="submit" className="mt-2 px-4 py-2 bg-primary text-white font-semibold rounded-md text-xs hover:bg-gray-800 transition-colors">Post Comment</button>
                </form>
            );
        };

        function ReviewForm({ campaignId, onSubmit }) {
            const [rating, setRating] = useState(5);
            const [comment, setComment] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if(comment.trim()) {
                    onSubmit(campaignId, { rating, comment });
                    setComment('');
                    setRating(5);
                }
            }
            return (
                <form onSubmit={handleSubmit} className="mt-6 pt-4 border-t border-subtle">
                    <h5 className="font-bold mb-2 text-sm">Write a Review</h5>
                    <div className="flex items-center mb-2">
                        {[...Array(5)].map((_, i) => <button type="button" key={i} onClick={() => setRating(i+1)}><StarIcon className={`w-5 h-5 transition-colors ${i < rating ? 'text-accent' : 'text-gray-300 hover:text-accent'}`} isFilled={i < rating} /></button>)}
                    </div>
                    <textarea value={comment} onChange={(e) => setComment(e.target.value)} className="w-full p-2 border border-subtle rounded-md text-sm bg-white focus:outline-none focus:ring-1 focus:ring-accent" placeholder="Share your thoughts on the fit and quality..."></textarea>
                    <button type="submit" className="mt-2 px-4 py-2 bg-accent text-white font-semibold rounded-md text-xs hover:bg-accent-dark transition-colors">Submit Review</button>
                </form>
            );
        };
        
        function ThreeDModal({ onClose }) {
            const [show, setShow] = useState(false);
            useEffect(() => { const timer = setTimeout(() => setShow(true), 10); return () => clearTimeout(timer); }, []);
            const handleClose = () => { setShow(false); setTimeout(onClose, 300); };
            return (
                <div className={`fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out ${show ? 'opacity-100' : 'opacity-0'}`} onClick={handleClose}>
                    <div className={`w-full h-full max-w-4xl max-h-[80vh] bg-subtle rounded-2xl shadow-2xl relative transform transition-all duration-300 ease-in-out overflow-hidden ${show ? 'opacity-100 scale-100' : 'opacity-0 scale-95'}`} onClick={(e) => e.stopPropagation()}>
                        <button onClick={handleClose} className="absolute top-4 right-4 text-secondary bg-white/50 rounded-full p-2 hover:bg-white z-10"> <XIcon className="w-5 h-5" /> </button>
                        <ThreeDViewer />
                    </div>
                </div>
            );
        }

        function MediaViewerModal({ campaign, startIndex, onClose }) {
            const mediaItems = [ ...[...new Set([campaign.heroImage, ...(campaign.images || [])])].map(img => ({ type: 'image', url: img, thumbnail: img })), ...(campaign.video ? [{ type: 'video', url: campaign.video.url, thumbnail: campaign.video.thumbnail }] : []) ];
            const [currentIndex, setCurrentIndex] = useState(startIndex);
            const [show, setShow] = useState(false);

            useEffect(() => {
                const timer = setTimeout(() => setShow(true), 10);
                return () => clearTimeout(timer);
            }, []);

            const handleClose = () => {
                setShow(false);
                setTimeout(onClose, 300);
            };

            return (
                <div className={`fixed inset-0 bg-black/80 z-[60] flex flex-col items-center justify-center p-4 transition-opacity duration-300 ease-in-out ${show ? 'opacity-100' : 'opacity-0'}`} onClick={handleClose}>
                    <button onClick={handleClose} className="absolute top-4 right-4 text-white bg-black/30 rounded-full p-2 hover:bg-black/50 z-10">
                        <XIcon className="w-6 h-6" />
                    </button>
                    <div className={`w-full h-full max-w-5xl max-h-[80vh] flex items-center justify-center transform transition-all duration-300 ease-in-out ${show ? 'opacity-100 scale-100' : 'opacity-0 scale-95'}`} onClick={(e) => e.stopPropagation()}>
                        {mediaItems[currentIndex].type === 'video' ? (
                            <video key={mediaItems[currentIndex].url} src={mediaItems[currentIndex].url} controls autoPlay className="max-w-full max-h-full object-contain rounded-lg"></video>
                        ) : (
                            <img src={mediaItems[currentIndex].url} alt="Full screen product view" className="max-w-full max-h-full object-contain rounded-lg" />
                        )}
                    </div>
                    <div className={`mt-4 flex space-x-2 overflow-x-auto scrollbar-hide transform transition-all duration-300 ease-in-out ${show ? 'opacity-100' : 'opacity-0'}`} onClick={(e) => e.stopPropagation()}>
                        {mediaItems.map((media, index) => (
                            <button key={index} onClick={() => setCurrentIndex(index)} className={`w-16 h-20 flex-shrink-0 rounded-md overflow-hidden border-2 relative ${currentIndex === index ? 'border-white' : 'border-transparent'}`}>
                                <img src={media.thumbnail} alt={media.type} className="w-full h-full object-cover" />
                                {media.type === 'video' && <div className="absolute inset-0 bg-black/30 flex items-center justify-center"><PlayIcon className="w-6 h-6 text-white" /></div>}
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        function PledgeModal({ campaign, onClose, onPledge }) {
            const [show, setShow] = useState(false);
            const [selectedSize, setSelectedSize] = useState(Object.keys(campaign.preOrderDetails.sizes)[0]);
            const isCombinedFunding = campaign.preOrderDetails.fundingType === 'COMBINED';
            useEffect(() => { const timer = setTimeout(() => setShow(true), 10); return () => clearTimeout(timer); }, []);
            const handleClose = () => { setShow(false); setTimeout(onClose, 300); };
            let combinedProgress = 0; let totalFunded = 0;
            if (isCombinedFunding) { totalFunded = Object.values(campaign.preOrderDetails.sizes).reduce((acc, size) => acc + size.funded, 0); combinedProgress = campaign.preOrderDetails.overallMoq > 0 ? (totalFunded / campaign.preOrderDetails.overallMoq) * 100 : 0; }
            return (
                <div className={`fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out ${show ? 'opacity-100' : 'opacity-0'}`} onClick={handleClose}>
                    <div className={`bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative transform transition-all duration-300 ease-in-out ${show ? 'opacity-100 scale-100' : 'opacity-0 scale-95'}`} onClick={(e) => e.stopPropagation()}>
                        <button onClick={handleClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"> <XIcon className="w-5 h-5" /> </button>
                        <h2 className="font-serif text-2xl font-medium mb-1">{campaign.name}</h2>
                        <p className="font-serif text-lg text-secondary mb-6">â¬{campaign.price}</p>
                        {isCombinedFunding && ( <div className="mb-4"> <h3 className="font-semibold text-xs uppercase tracking-wider text-secondary mb-2">Overall Funding</h3> <div className="w-full bg-subtle rounded-full h-1.5"> <div className="bg-accent h-1.5 rounded-full" style={{ width: `${combinedProgress}%` }}></div> </div> <div className="flex justify-between items-center text-xs text-secondary mt-1"> <span>{totalFunded} / {campaign.preOrderDetails.overallMoq} Funded</span> <span className="font-semibold">{campaign.preOrderDetails.daysLeft} days left</span> </div> </div> )}
                        <div className="mb-4"> <h3 className="font-semibold text-xs uppercase tracking-wider text-secondary mb-3">{isCombinedFunding ? 'Pledges by Size' : 'Funding by Size'}</h3> <div className="space-y-3"> {Object.entries(campaign.preOrderDetails.sizes).map(([size, data]) => { if (isCombinedFunding) { return ( <div key={size} className="flex justify-between items-center text-sm py-1"> <span className="font-medium text-primary">{size}</span> <span className="text-secondary font-semibold">{data.funded} pledged</span> </div> ) } const moq = data.moq; const progress = moq ? (data.funded / moq) * 100 : 0; const isFunded = moq && progress >= 100; return ( <div key={size}> <div className={`flex justify-between items-center mb-1 text-xs ${isFunded ? 'text-success font-semibold' : 'text-secondary'}`}> <span className="font-semibold">{size}</span> {moq && <span>{data.funded} / {moq}</span>} </div> {moq && <div className="w-full bg-subtle rounded-full h-1.5"> <div className={`${isFunded ? 'bg-success' : 'bg-accent'} h-1.5 rounded-full`} style={{ width: `${Math.min(progress, 100)}%` }}></div> </div>} </div> ); })} </div> </div>
                        <div className="mb-6"> <h3 className="font-semibold text-xs uppercase tracking-wider text-secondary mb-2">Select Size</h3> <div className="flex space-x-2 overflow-x-auto pb-2 scrollbar-hide"> {Object.keys(campaign.preOrderDetails.sizes).map(size => ( <button key={size} onClick={() => setSelectedSize(size)} className={`px-4 py-2 rounded-md border transition-all text-xs font-semibold ${selectedSize === size ? 'bg-primary text-white border-primary' : 'bg-white text-secondary border-subtle'}`}> {size} </button> ))} </div> </div>
                        <div className="bg-subtle border-l-4 border-accent p-3 rounded-r-lg mb-6"> <p className="text-xs text-secondary">Your card will only be charged if the funding goal is met.</p> </div>
                        <button onClick={() => onPledge(campaign, selectedSize)} className="w-full bg-accent text-white font-bold py-3 rounded-md hover:bg-accent-dark transition-all text-sm"> Confirm Pledge for Size {selectedSize} </button>
                    </div>
                </div>
            );
        };
        
        function ThreeDViewer() {
            const mountRef = useRef(null);
            const isDragging = useRef(false);
            const previousPointerPosition = useRef({ x: 0, y: 0 });
            const initialPinchDistance = useRef(0);

            useEffect(() => {
                const currentMount = mountRef.current;
                if (!currentMount) return;

                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf5f5f5);
                const camera = new THREE.PerspectiveCamera(50, currentMount.clientWidth / currentMount.clientHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(currentMount.clientWidth, currentMount.clientHeight);
                currentMount.appendChild(renderer.domElement);

                const geometry = new THREE.TorusKnotGeometry(10, 3, 100, 16);
                const material = new THREE.MeshStandardMaterial({ color: 0x004D40, roughness: 0.4, metalness: 0.3 });
                const torusKnot = new THREE.Mesh(geometry, material);
                scene.add(torusKnot);

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.8);
                scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xffffff, 0.7);
                pointLight.position.set(25, 50, 25);
                scene.add(pointLight);

                camera.position.z = 30;

                const getPointerCoordinates = (event) => event.touches ? { x: event.touches[0].clientX, y: event.touches[0].clientY } : { x: event.clientX, y: event.clientY };
                const getPinchDistance = (event) => {
                    const dx = event.touches[0].clientX - event.touches[1].clientX;
                    const dy = event.touches[0].clientY - event.touches[1].clientY;
                    return Math.sqrt(dx * dx + dy * dy);
                };
                const onPointerDown = (e) => {
                    if (e.touches && e.touches.length === 2) {
                        initialPinchDistance.current = getPinchDistance(e);
                        isDragging.current = false;
                    } else {
                        isDragging.current = true;
                        currentMount.classList.add('cursor-grabbing');
                        const coords = getPointerCoordinates(e);
                        previousPointerPosition.current = { x: coords.x, y: coords.y };
                    }
                };
                const onPointerUp = () => {
                    isDragging.current = false;
                    initialPinchDistance.current = 0;
                    currentMount.classList.remove('cursor-grabbing');
                };
                const onPointerMove = (e) => {
                    e.preventDefault(); 
                    if (e.touches && e.touches.length === 2) {
                        const newPinchDistance = getPinchDistance(e);
                        const delta = newPinchDistance - initialPinchDistance.current;
                        camera.position.z -= delta * 0.1;
                        camera.position.z = Math.max(15, Math.min(camera.position.z, 50));
                        initialPinchDistance.current = newPinchDistance;
                    } else if (isDragging.current) {
                        const coords = getPointerCoordinates(e);
                        const deltaMove = { x: coords.x - previousPointerPosition.current.x, y: coords.y - previousPointerPosition.current.y };
                        const deltaRotationQuaternion = new THREE.Quaternion().setFromEuler(new THREE.Euler((deltaMove.y * Math.PI) / 180, (deltaMove.x * Math.PI) / 180, 0, 'XYZ'));
                        torusKnot.quaternion.multiplyQuaternions(deltaRotationQuaternion, torusKnot.quaternion);
                        previousPointerPosition.current = { x: coords.x, y: coords.y };
                    }
                };
                const onWheel = (e) => {
                    camera.position.z += e.deltaY * 0.05;
                    camera.position.z = Math.max(15, Math.min(camera.position.z, 50));
                };

                currentMount.addEventListener('mousedown', onPointerDown);
                window.addEventListener('mouseup', onPointerUp);
                window.addEventListener('mousemove', onPointerMove);
                currentMount.addEventListener('touchstart', onPointerDown, { passive: false });
                window.addEventListener('touchend', onPointerUp);
                window.addEventListener('touchmove', onPointerMove, { passive: false });
                currentMount.addEventListener('wheel', onWheel, { passive: false });

                const animate = function () { requestAnimationFrame(animate); renderer.render(scene, camera); };
                animate();
                
                const handleResize = () => {
                    if (currentMount) {
                        camera.aspect = currentMount.clientWidth / currentMount.clientHeight;
                        camera.updateProjectionMatrix();
                        renderer.setSize(currentMount.clientWidth, currentMount.clientHeight);
                    }
                }
                window.addEventListener('resize', handleResize);

                return () => {
                    window.removeEventListener('resize', handleResize);
                    window.removeEventListener('mouseup', onPointerUp);
                    window.removeEventListener('mousemove', onPointerMove);
                    window.removeEventListener('touchend', onPointerUp);
                    window.removeEventListener('touchmove', onPointerMove);
                    if(currentMount && renderer.domElement) {
                       currentMount.removeChild(renderer.domElement);
                    }
                };
            }, []);
            return <div ref={mountRef} className="w-full h-full cursor-grab"></div>;
        }

        // --- RENDER THE APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
