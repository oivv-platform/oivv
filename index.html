<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MePont | Community-Powered Fashion</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            overscroll-behavior: none;
        }
        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }
        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
        .cursor-grab {
            cursor: grab;
        }
        .cursor-grabbing {
            cursor: grabbing;
        }
        .blur-background {
            filter: blur(4px);
            transition: filter 0.3s ease-in-out;
        }
        
        /* Keyframes for the island notification */
        @keyframes island-notify-bg {
            0%, 100% { background-color: rgba(17, 24, 39, 0.75); } /* bg-gray-900/75 */
            10%, 90% { background-color: rgba(5, 150, 105, 0.85); } /* bg-emerald-600 with more opacity */
        }

        @keyframes island-notify-text {
            0% { transform: translateX(100%); opacity: 0; }
            10%, 90% { transform: translateX(0); opacity: 1; }
            100% { transform: translateX(-100%); opacity: 0; }
        }

        .island-notification-bg-animate {
            animation: island-notify-bg 3s ease-in-out forwards;
        }
        
        .island-notification-text-animate {
            animation: island-notify-text 3s ease-in-out forwards;
        }
    </style>
</head>
<body class="bg-gray-100">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;

        // --- MOCK DATA (ENHANCED) ---
        const MOCK_CAMPAIGNS = [
            { 
                id: 1, 
                name: 'The Milano Linen Blazer', 
                designer: 'Studio Rossi', 
                price: 85, 
                stage: 'PRE_ORDER', 
                productionRound: 2, 
                category: 'Blazers',
                dateAdded: '2024-06-20T10:00:00Z',
                heroImage: 'https://images.unsplash.com/photo-1594938384914-29a4491a9599?q=80&w=800', 
                images: [ 'https://images.unsplash.com/photo-1594938384914-29a4491a9599?q=80&w=800', 'https://images.unsplash.com/photo-1617137968427-4dd4bf633758?q=80&w=800', 'https://images.unsplash.com/photo-1551028719-00167b16eac5?q=80&w=800' ], 
                video: {thumbnail: 'https://placehold.co/800x1000/64748b/ffffff?text=Video', url: 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerEscapes.mp4'}, 
                details: 'Crafted from 100% organic Italian linen, this blazer offers a relaxed yet structured fit. Perfect for summer evenings and smart-casual events. Features natural horn buttons and a silk-blend lining.', 
                preOrderDetails: { fundingType: 'INDEPENDENT', daysLeft: 12, sizes: { 'S': { moq: 50, funded: 50 }, 'M': { moq: 100, funded: 98 }, 'L': { moq: 100, funded: 35 }, 'XL': { moq: 50, funded: 2 } } }, 
                priceBreakdown: { materials: 35, manufacturing: 31, designer: 10, platform: 8.5 }, 
                sizeGuide: { fitDetails: 'Relaxed, unstructured fit. Designed to be worn comfortably over a shirt. Consider sizing down for a slimmer fit.', sizes: { 'S': { 'Chest': '38"', 'Sleeve': '25"', 'Length': '28"' }, 'M': { 'Chest': '40"', 'Sleeve': '25.5"', 'Length': '28.5"' }, 'L': { 'Chest': '42"', 'Sleeve': '26"', 'Length': '29"' }, 'XL': { 'Chest': '44"', 'Sleeve': '26.5"', 'Length': '29.5"' }, } }, 
                garmentCare: { composition: '100% Organic Linen, 100% Cupro Lining', instructions: ['Dry clean only', 'Iron on low heat', 'Do not tumble dry'] },
                comments: [{user: 'Julia S.', comment: 'So excited for Round 2!'}], 
                reviews: [ { user: 'Alex R.', rating: 5, comment: 'Received this from the first round. The quality is absolutely insane for the price. The linen is soft, not scratchy at all.'}, { user: 'Beatrice L.', rating: 4, comment: 'Beautiful blazer, though it runs a little large. I would recommend sizing down if you are between sizes.'}, ], 
                has3D: true,
                manufacturer: { name: 'Artisan Tailors Lda', country: 'Portugal' },
                digitalPassport: { uniqueId: 'MEP-2025-0001', manufacturerInfo: { name: 'Artisan Tailors Lda', address: 'Rua das Flores 123, 4050-262 Porto, Portugal', contact: 'production@artisans.pt' }, supplyChain: [ { component: 'Main Fabric', material: '100% Organic Linen', supplier: 'Solbiati S.r.l.', origin: 'Emilia-Romagna, Italy' }, { component: 'Lining', material: '50% Cupro, 50% Viscose', supplier: 'Manifattura Pezzetti', origin: 'Como, Italy' }, { component: 'Buttons', material: 'Natural Horn', supplier: 'Bottonificio Padano', origin: 'Parma, Italy' }, { component: 'Sewing Thread', material: '100% Recycled Polyester', supplier: 'Coats Group plc', origin: 'United Kingdom' } ], sustainability: { recycledContent: '10% (sewing thread)', durability: 'High resistance to pilling. Tested for 50+ wash cycles.', repairability: { score: '8/10', details: 'Spare buttons included. Fabric patches available upon request. Standard seam construction allows for easy alterations.' }, endOfLife: { instructions: 'Fabric is biodegradable and compostable. Please remove buttons before disposal. Consider donating or returning via our take-back program.', recyclable: true } }, compliance: { svhc: 'None', certifications: ['European Flax® Certified', 'OEKO-TEX Standard 100 (Lining)'] } }
            },
            { 
                id: 7, 
                name: 'The Nomad Travel Shirt', 
                designer: 'Wayfarer Co.', 
                price: 65, 
                stage: 'SAMPLING', 
                productionRound: 1, 
                category: 'Tops', 
                dateAdded: '2024-07-01T10:00:00Z',
                heroImage: 'https://images.unsplash.com/photo-1603252109360-778ba9913158?q=80&w=800', 
                images: ['https://images.unsplash.com/photo-1603252109360-778ba9913158?q=80&w=800', 'https://images.unsplash.com/photo-1564859228273-204232441043?q=80&w=800', 'https://images.unsplash.com/photo-1589902860377-128a3e284873?q=80&w=800'], 
                video: {thumbnail: 'https://placehold.co/800x1000/9ca3af/ffffff?text=Video', url: 'http://commondatastorage.googleapis.com/gtv-videos-bucket/sample/ForBiggerJoyrides.mp4'}, 
                details: 'The only shirt you need. Made from a technical merino wool blend that is wrinkle-resistant, anti-odor, and temperature regulating.',
                designerUpdates: [ { date: '3 days ago', title: 'First Sample Arrived!', text: 'The first physical sample is here and it feels incredible. The merino blend is super soft. We are now testing the fit and making minor adjustments to the collar.' }, { date: '1 week ago', title: 'Fabric Confirmed', text: 'We have officially confirmed the 87/13 Merino/Nylon blend from Nippon Wool Co. The quality is exceptional and perfect for our requirements.' } ],
                preOrderDetails: { fundingType: 'COMBINED', daysLeft: 18, overallMoq: 200, sizes: { 'S': { funded: 30 }, 'M': { funded: 65 }, 'L': { funded: 40 }, 'XL': { funded: 15 } } },
                priceBreakdown: { materials: 25, manufacturing: 22, designer: 10, platform: 6.5 }, 
                sizeGuide: { fitDetails: 'Modern athletic fit. Not too slim, not too loose.', sizes: { 'S': { 'Chest': '38"', 'Length': '28"' }, 'M': { 'Chest': '40"', 'Length': '29"' }, 'L': { 'Chest': '42"', 'Length': '30"' }, 'XL': { 'Chest': '44"', 'Length': '30.5"' }, } }, 
                garmentCare: { composition: '87% Merino Wool, 13% Nylon', instructions: ['Machine wash cold, gentle cycle', 'Lay flat to dry', 'Do not bleach'] },
                comments: [], 
                reviews: [], 
                has3D: false,
                manufacturer: { name: 'TechFabrics Vietnam', country: 'Vietnam' },
                digitalPassport: { uniqueId: 'MEP-2025-0007', manufacturerInfo: { name: 'TechFabrics Vietnam Co., Ltd.', address: 'Lot 4, Tan Thuan EPZ, Ho Chi Minh City, Vietnam', contact: 'compliance@techfab.vn' }, supplyChain: [ { component: 'Main Fabric', material: '87% Merino Wool, 13% Nylon', supplier: 'Nippon Wool Co.', origin: 'Japan (Milling)' }, { component: 'Wool Fiber', material: '100% Merino Wool', supplier: 'Australian Wool Network', origin: 'Australia' } ], sustainability: { recycledContent: 'None', durability: 'Excellent wrinkle and odor resistance.', repairability: { score: '6/10', details: 'Standard repairs possible by any tailor.' }, endOfLife: { instructions: 'Fabric is recyclable where textile recycling facilities exist.', recyclable: true } }, compliance: { svhc: 'None', certifications: ['Responsible Wool Standard (RWS)'] } }
            },
            {
                id: 3,
                name: 'The Urban Explorer Trouser',
                designer: 'Concrete Collective',
                price: 75,
                stage: 'DESIGN',
                category: 'Trousers',
                dateAdded: '2024-07-10T10:00:00Z',
                heroImage: 'https://images.unsplash.com/photo-1541099649105-f69ad21f3246?q=80&w=800',
                images: ['https://images.unsplash.com/photo-1541099649105-f69ad21f3246?q=80&w=800'],
                details: 'A modern, technical trouser designed for life on the move. Constructed from a durable, water-repellent stretch canvas, it features a gusseted crotch for freedom of movement and a secure zip pocket for your essentials.',
                likes: 184,
                targetLikes: 250,
                priceBreakdown: { materials: 30, manufacturing: 25, designer: 12, platform: 8 },
                sizeGuide: { fitDetails: 'Slim-tapered fit. Articulated knees for ease of movement.', sizes: { 'S': {}, 'M': {}, 'L': {}, 'XL': {} } },
                garmentCare: { composition: '98% Cotton, 2% Elastane with DWR finish', instructions: ['Machine wash cold', 'Tumble dry low', 'Do not use fabric softener'] },
                comments: [],
                reviews: [],
                has3D: false,
                manufacturer: { name: 'To be determined', country: 'TBD' },
                digitalPassport: null
            },
            { 
                id: 4, 
                name: 'The Essential Pima Tee', 
                designer: 'Plain Goods', 
                price: 35, 
                stage: 'CONFIRMED', 
                productionRound: 1, 
                category: 'Tops', 
                dateAdded: '2024-06-15T10:00:00Z',
                heroImage: 'https://images.unsplash.com/photo-1583743814966-8936f5b7be1a?q=80&w=800', 
                images: ['https://images.unsplash.com/photo-1583743814966-8936f5b7be1a?q=80&w=800'], 
                details: 'The perfect t-shirt does exist. Made from 100% Peruvian Pima cotton, known for its exceptional softness and durability. A classic crewneck silhouette with a modern, tailored fit.', 
                preOrderDetails: { fundingType: 'COMBINED', daysLeft: 0, overallMoq: 300, sizes: { 'S': { funded: 80 }, 'M': { funded: 150 }, 'L': { funded: 100 }, 'XL': { funded: 50 } } },
                priceBreakdown: { materials: 12, manufacturing: 10, designer: 5, platform: 3.5 }, 
                sizeGuide: { fitDetails: 'Tailored fit. Size up for a more relaxed feel.', sizes: { 'S': { 'Chest': '38"', 'Length': '28"' }, 'M': { 'Chest': '40"', 'Length': '29"' }, 'L': { 'Chest': '42"', 'Length': '30"' }, 'XL': { 'Chest': '44"', 'Length': '30.5"' }, } }, 
                garmentCare: { composition: '100% Pima Cotton', instructions: ['Machine wash cold with like colors', 'Tumble dry low', 'Warm iron if needed'] },
                comments: [], 
                reviews: [], 
                has3D: false,
                manufacturer: { name: 'Cotton Experts S.A.C.', country: 'Peru' },
                digitalPassport: { uniqueId: 'MEP-2025-0004', manufacturerInfo: { name: 'Cotton Experts S.A.C.', address: 'Av. Industrial 150, Ate, Lima, Peru', contact: 'contact@cottonexperts.pe' }, supplyChain: [ { component: 'Main Fabric', material: '100% Pima Cotton', supplier: 'IncaCotton', origin: 'Piura, Peru' } ], sustainability: { recycledContent: 'None', durability: 'High', repairability: { score: '7/10', details: 'Standard repairs possible.' }, endOfLife: { instructions: 'Fabric is biodegradable.', recyclable: true } }, compliance: { svhc: 'None', certifications: ['Peruvian Pima Cotton Certified'] } }
            },
        ];

        // --- UI ICONS ---
        const InfoIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>;
        const ShirtIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.38 3.46 16 2a4 4 0 0 1-8 0L3.62 3.46a2 2 0 0 0-1.34 2.23l.58 3.47a1 1 0 0 0 .99.84H6v10c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V10h2.15a1 1 0 0 0 .99-.84l.58-3.47a2 2 0 0 0-1.34-2.23z"></path></svg>;
        const TagIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M12 2H2v10l9.29 9.29c.94.94 2.48.94 3.42 0l6.58-6.58c.94-.94.94-2.48 0-3.42L12 2z"></path><path d="M7 7h.01"></path></svg>;
        const RulerIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21.3 15.3a2.4 2.4 0 0 1 0 3.4l-2.6 2.6a2.4 2.4 0 0 1-3.4 0L3 8.4a2.4 2.4 0 0 1 0-3.4l2.6-2.6a2.4 2.4 0 0 1 3.4 0L15.3 9"></path><path d="m14.5 12.5 2-2"></path><path d="m11.5 9.5 2-2"></path><path d="m8.5 6.5 2-2"></path><path d="m17.5 15.5 2-2"></path></svg>;
        const UsersIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path><circle cx="9" cy="7" r="4"></circle><path d="M22 21v-2a4 4 0 0 0-3-3.87"></path><path d="M16 3.13a4 4 0 0 1 0 7.75"></path></svg>;
        const PlayIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" className={className}><path d="M8 5v14l11-7z"></path></svg>;
        const CubeIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"></path><polyline points="3.27 6.96 12 12.01 20.73 6.96"></polyline><line x1="12" y1="22.08" x2="12" y2="12"></line></svg>;
        const HomeIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path><polyline points="9 22 9 12 15 12 15 22"></polyline></svg>;
        const UserIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>;
        const XIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg>;
        const HeartIcon = ({ className, isFilled }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill={isFilled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M20.84 4.61a5.5 5.5 0 0 0-7.78 0L12 5.67l-1.06-1.06a5.5 5.5 0 0 0-7.78 7.78l1.06 1.06L12 21.23l7.78-7.78 1.06-1.06a5.5 5.5 0 0 0 0-7.78z"></path></svg>;
        const ListIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="8" y1="6" x2="21" y2="6"></line><line x1="8" y1="12" x2="21" y2="12"></line><line x1="8" y1="18" x2="21" y2="18"></line><line x1="3" y1="6" x2="3.01" y2="6"></line><line x1="3" y1="12" x2="3.01" y2="12"></line><line x1="3" y1="18" x2="3.01" y2="18"></line></svg>;
        const ArrowRightIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="3" strokeLinecap="round" strokeLinejoin="round" className={className}><line x1="5" y1="12" x2="19" y2="12"></line><polyline points="12 5 19 12 12 19"></polyline></svg>;
        const StarIcon = ({ className, isFilled }) => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill={isFilled ? "currentColor" : "none"} stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>;
        const EUFlagIcon = () => <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 60 40" width="24" height="16"><path fill="#003399" d="M0 0h60v40H0z"/><g transform="translate(30,20) scale(1.3)"><g id="s"><g id="c"><path id="t" d="M0,-12 V0 H6 Z" transform="rotate(18 0 -12)" fill="#FFCC00"/><use href="#t" transform="scale(-1,1)"/></g><use href="#c" transform="rotate(72)"/><use href="#c" transform="rotate(144)"/><use href="#c" transform="rotate(216)"/><use href="#c" transform="rotate(288)"/></g></g></svg>;
        const CheckCircleIcon = ({ className }) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round" className={className}><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>;

        // --- MAIN APP COMPONENT ---
        function App() {
            const [isLoading, setIsLoading] = useState(true);
            const [currentScreen, setCurrentScreen] = useState('Home');
            const [campaigns, setCampaigns] = useState([]);
            const [pledgedItems, setPledgedItems] = useState([]);
            const [waitingListItems, setWaitingListItems] = useState([]);
            const [likedItems, setLikedItems] = useState([]);
            const [showPledgeModal, setShowPledgeModal] = useState(false);
            const [show3DModal, setShow3DModal] = useState(false);
            const [showMediaModal, setShowMediaModal] = useState({ visible: false, startIndex: 0 });
            const [showCampaignModal, setShowCampaignModal] = useState(null);
            const [dashboardView, setDashboardView] = useState('My MePont'); 

            useEffect(() => {
                setTimeout(() => {
                    setCampaigns(MOCK_CAMPAIGNS);
                    setLikedItems(MOCK_CAMPAIGNS.filter(c => c.id === 3));
                    setIsLoading(false);
                }, 1500);
            }, []);

            const isModalOpen = showPledgeModal || show3DModal || showMediaModal.visible || !!showCampaignModal;
            const isNestedModalOpen = (!!showCampaignModal) && (showPledgeModal || show3DModal || showMediaModal.visible);
            
            useEffect(() => {
                const updatedCampaigns = campaigns.map(c => {
                    if (c.stage === 'DESIGN' && c.likes >= c.targetLikes) {
                        return { ...c, stage: 'SAMPLING' }; 
                    }
                    return c;
                });
                if (JSON.stringify(updatedCampaigns) !== JSON.stringify(campaigns)) {
                    setCampaigns(updatedCampaigns);
                }
            }, [campaigns]);

            const productionSteps = ['Confirmed', 'Fabric Sourced', 'In Production', 'Quality Check', 'Shipped'];
            useEffect(() => {
                const interval = setInterval(() => {
                    setPledgedItems(prevItems =>
                        prevItems.map(item => {
                            const currentStepIndex = productionSteps.indexOf(item.productionStatus);
                            if (item.productionStatus !== 'Shipped' && Math.random() < 0.2) {
                                const nextStepIndex = currentStepIndex + 1;
                                return { ...item, productionStatus: productionSteps[nextStepIndex] };
                            }
                            return item;
                        })
                    );
                }, 5000); 

                return () => clearInterval(interval);
            }, []);

            const hasPurchased = (campaignId) => pledgedItems.some(item => item.id === campaignId);
            
            const navigateTo = (screen, view = 'My MePont') => {
                setShowCampaignModal(null);
                setCurrentScreen(screen);
                if (screen === 'Dashboard') {
                    setDashboardView(view);
                }
            }

            const viewCampaignDetail = (campaign) => {
                setShowCampaignModal(campaign);
            };
            
            const handleLike = (campaignId, showNotification) => {
                const campaign = campaigns.find(c => c.id === campaignId);
                let isNowLiked = false;
                setLikedItems(prev => {
                    const isLiked = prev.some(item => item.id === campaignId);
                    if (isLiked) {
                        isNowLiked = false;
                        return prev.filter(item => item.id !== campaignId);
                    } else {
                        isNowLiked = true;
                        return [...prev, campaign];
                    }
                });
                setCampaigns(prev => prev.map(c => {
                    if (c.id === campaignId && c.stage === 'DESIGN') {
                        return {...c, likes: isNowLiked ? c.likes + 1 : c.likes - 1};
                    }
                    return c;
                }));
                if(showNotification) showNotification(isNowLiked ? `Added to Liked Items` : `Removed from Liked`);
            };

            const handleAddToWaitingList = (campaignId, showNotification) => {
                const campaign = campaigns.find(c => c.id === campaignId);
                let isNowOnList = false;
                setWaitingListItems(prev => {
                    const isOnList = prev.some(item => item.id === campaignId);
                    if (isOnList) {
                        isNowOnList = false;
                        return prev.filter(item => item.id !== campaignId);
                    } else {
                        isNowOnList = true;
                        return [...prev, campaign];
                    }
                });
                if(showNotification) showNotification(isNowOnList ? 'Added to Waiting List' : 'Removed from List');
            };

            const handlePledge = (campaign, size, showNotification) => {
                const newPledge = { ...campaign, size, productionStatus: 'Confirmed' };
                setPledgedItems(prev => [...prev, newPledge]);
                setCampaigns(prevCampaigns =>
                    prevCampaigns.map(c => {
                        if (c.id === campaign.id && c.stage === 'PRE_ORDER') {
                            const updatedSizes = { ...c.preOrderDetails.sizes };
                            if(updatedSizes[size]) {
                                updatedSizes[size].funded += 1;
                            }
                            const totalFunded = Object.values(updatedSizes).reduce((acc, s) => acc + s.funded, 0);
                            const newStage = c.preOrderDetails.fundingType === 'COMBINED' && totalFunded >= c.preOrderDetails.overallMoq ? 'CONFIRMED' : c.stage;
                            return { ...c, stage: newStage, preOrderDetails: { ...c.preOrderDetails, sizes: updatedSizes }};
                        }
                        return c;
                    })
                );
                setShowPledgeModal(false);
                if(showNotification) showNotification(`Pledge for Size ${size} Confirmed!`);
            };
            
            const addComment = (campaignId, commentText, showNotification) => {
                const newComment = { user: 'You', comment: commentText };
                setCampaigns(prev => prev.map(c => 
                    c.id === campaignId ? {...c, comments: [...c.comments, newComment]} : c
                ));
                 if(showNotification) showNotification('Comment Posted!');
            };
            
            const addReview = (campaignId, review, showNotification) => {
                const newReview = { user: 'You', ...review };
                setCampaigns(prev => prev.map(c => 
                    c.id === campaignId ? {...c, reviews: [...c.reviews, newReview]} : c
                ));
                if(showNotification) showNotification('Review Submitted!');
            };

            const renderScreen = () => {
                if (isLoading) {
                    return <HomeScreenSkeleton />;
                }
                switch (currentScreen) {
                    case 'Home':
                        return <HomeScreen campaigns={campaigns} onCampaignSelect={viewCampaignDetail} onLike={(id) => handleLike(id, null)} likedItems={likedItems} />;
                    case 'Dashboard':
                        return <DashboardScreen 
                                    pledgedItems={pledgedItems} 
                                    waitingListItems={waitingListItems}
                                    likedItems={likedItems}
                                    productionSteps={productionSteps}
                                    activeView={dashboardView}
                                    onNavigate={navigateTo}
                                    onCampaignSelect={viewCampaignDetail}
                                    onLike={(id) => handleLike(id, null)}
                                />;
                    default:
                        return <HomeScreen campaigns={campaigns} onCampaignSelect={viewCampaignDetail} onLike={(id) => handleLike(id, null)} likedItems={likedItems} />;
                }
            };

            return (
                <div className="w-full min-h-screen">
                    <div className={isModalOpen ? 'blur-background' : ''}>
                        <TopNavBar onNavigate={navigateTo} currentScreen={currentScreen} dashboardView={dashboardView} />
                        <div className="max-w-7xl mx-auto pt-24">
                            <main>
                                {renderScreen()}
                            </main>
                        </div>
                    </div>
                    
                    {showCampaignModal && 
                        <CampaignDetailModal 
                            campaign={showCampaignModal} 
                            onPledge={() => setShowPledgeModal(true)} 
                            onBack={() => setShowCampaignModal(null)}
                            onLike={handleLike}
                            isLiked={likedItems.some(item => item.id === showCampaignModal.id)}
                            hasPurchased={hasPurchased(showCampaignModal.id)}
                            onCommentSubmit={addComment}
                            onReviewSubmit={addReview}
                            onShow3D={() => setShow3DModal(true)}
                            onShowMedia={(startIndex) => setShowMediaModal({ visible: true, startIndex: startIndex })}
                            isNestedModalOpen={isNestedModalOpen}
                            onAddToWaitingList={handleAddToWaitingList}
                            isOnWaitingList={waitingListItems.some(item => item.id === showCampaignModal.id)}
                        />
                    }
                    {showPledgeModal && <PledgeModal campaign={showCampaignModal} onClose={() => setShowPledgeModal(false)} onPledge={(campaign, size) => handlePledge(campaign, size, null)} />}
                    {show3DModal && <ThreeDModal onClose={() => setShow3DModal(false)} />}
                    {showMediaModal.visible && <MediaViewerModal campaign={showCampaignModal} startIndex={showMediaModal.startIndex} onClose={() => setShowMediaModal({ visible: false, startIndex: 0 })} />}
                </div>
            );
        }

        // --- 3D VIEWER COMPONENT ---
        function ThreeDViewer() {
            const mountRef = useRef(null);
            useEffect(() => {
                const currentMount = mountRef.current;
                if (!currentMount) return;

                const scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf1f5f9);
                const camera = new THREE.PerspectiveCamera(50, currentMount.clientWidth / currentMount.clientHeight, 0.1, 1000);
                const renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(currentMount.clientWidth, currentMount.clientHeight);
                currentMount.appendChild(renderer.domElement);

                const geometry = new THREE.TorusKnotGeometry(10, 3, 100, 16);
                const material = new THREE.MeshStandardMaterial({ color: 0x3b82f6, roughness: 0.5, metalness: 0.2 });
                const torusKnot = new THREE.Mesh(geometry, material);
                scene.add(torusKnot);

                const ambientLight = new THREE.AmbientLight(0xffffff, 0.7);
                scene.add(ambientLight);
                const pointLight = new THREE.PointLight(0xffffff, 0.8);
                pointLight.position.set(25, 50, 25);
                scene.add(pointLight);

                camera.position.z = 30;
                
                let isDragging = false;
                let previousPointerPosition = { x: 0, y: 0 };

                const onPointerDown = (e) => {
                    isDragging = true;
                    currentMount.classList.add('cursor-grabbing');
                    previousPointerPosition = { x: e.clientX || e.touches[0].clientX, y: e.clientY || e.touches[0].clientY };
                };

                const onPointerUp = () => {
                    isDragging = false;
                    currentMount.classList.remove('cursor-grabbing');
                };

                const onPointerMove = (e) => {
                    if (!isDragging) return;
                    const clientX = e.clientX || e.touches[0].clientX;
                    const clientY = e.clientY || e.touches[0].clientY;
                    const deltaMove = {
                        x: clientX - previousPointerPosition.x,
                        y: clientY - previousPointerPosition.y
                    };
                    const deltaRotationQuaternion = new THREE.Quaternion().setFromEuler(
                        new THREE.Euler((deltaMove.y * Math.PI) / 180, (deltaMove.x * Math.PI) / 180, 0, 'XYZ')
                    );
                    torusKnot.quaternion.multiplyQuaternions(deltaRotationQuaternion, torusKnot.quaternion);
                    previousPointerPosition = { x: clientX, y: clientY };
                };
                
                const onWheel = (e) => {
                    camera.position.z += e.deltaY * 0.05;
                    camera.position.z = Math.max(15, Math.min(camera.position.z, 50));
                };

                currentMount.addEventListener('mousedown', onPointerDown);
                window.addEventListener('mouseup', onPointerUp);
                window.addEventListener('mousemove', onPointerMove);
                currentMount.addEventListener('touchstart', onPointerDown, { passive: true });
                window.addEventListener('touchend', onPointerUp);
                window.addEventListener('touchmove', onPointerMove, { passive: true });
                currentMount.addEventListener('wheel', onWheel, { passive: false });

                const animate = function () { requestAnimationFrame(animate); renderer.render(scene, camera); };
                animate();
                
                const handleResize = () => {
                    if (currentMount) {
                        camera.aspect = currentMount.clientWidth / currentMount.clientHeight;
                        camera.updateProjectionMatrix();
                        renderer.setSize(currentMount.clientWidth, currentMount.clientHeight);
                    }
                }
                window.addEventListener('resize', handleResize);

                return () => {
                    window.removeEventListener('resize', handleResize);
                    window.removeEventListener('mouseup', onPointerUp);
                    window.removeEventListener('mousemove', onPointerMove);
                    window.removeEventListener('touchend', onPointerUp);
                    window.removeEventListener('touchmove', onPointerMove);
                    if(currentMount && renderer.domElement) {
                       currentMount.removeChild(renderer.domElement);
                    }
                };
            }, []);
            return <div ref={mountRef} className="w-full h-full cursor-grab"></div>;
        }

        // --- SCREENS ---
        function HomeScreen({ campaigns, onCampaignSelect, onLike, likedItems }) {
            const [selectedCategory, setSelectedCategory] = useState('All');
            const [sortBy, setSortBy] = useState('Newest');

            const categories = ['All', 'Outerwear', 'Blazers', 'Trousers', 'Tops', 'Denim', 'Dresses', 'Accessories'];
            
            const sortedAndFilteredCampaigns = useMemo(() => {
                let filtered = campaigns.filter(campaign => selectedCategory === 'All' || campaign.category === selectedCategory);
                
                switch(sortBy) {
                    case 'Newest':
                        return filtered.sort((a, b) => new Date(b.dateAdded) - new Date(a.dateAdded));
                    case 'Ending Soon':
                        return filtered.sort((a, b) => (a.preOrderDetails?.daysLeft || Infinity) - (b.preOrderDetails?.daysLeft || Infinity));
                    case 'Price: Low to High':
                        return filtered.sort((a, b) => a.price - b.price);
                    case 'Price: High to Low':
                        return filtered.sort((a, b) => b.price - a.price);
                    default:
                        return filtered;
                }
            }, [campaigns, selectedCategory, sortBy]);

            return (
                <div className="p-4 sm:p-6 lg:p-8">
                    <header className="mb-8 text-center">
                        <h1 className="text-4xl sm:text-5xl font-extrabold tracking-tight text-gray-900">MePont</h1>
                        <p className="mt-2 text-lg text-gray-600">Community-powered fashion. Sell then make.</p>
                    </header>
                    <div className="mb-4">
                        <div className="flex justify-center flex-wrap gap-2">
                        {categories.map(category => (
                            <button key={category} onClick={() => setSelectedCategory(category)} className={`px-4 py-2 rounded-full font-semibold text-sm transition-colors whitespace-nowrap ${selectedCategory === category ? 'bg-blue-600 text-white' : 'bg-white text-gray-700 shadow-sm hover:bg-gray-50'}`}>
                            {category}
                            </button>
                        ))}
                        </div>
                    </div>
                    <div className="mb-8 flex justify-center">
                        <div className="flex items-center gap-2 bg-white p-1 rounded-full shadow-sm">
                            <span className="text-sm font-semibold text-gray-600 pl-2">Sort by:</span>
                            <select value={sortBy} onChange={(e) => setSortBy(e.target.value)} className="bg-transparent font-semibold text-blue-600 rounded-full py-1 pr-8 border-none focus:ring-0 text-sm">
                                <option>Newest</option>
                                <option>Ending Soon</option>
                                <option>Price: Low to High</option>
                                <option>Price: High to Low</option>
                            </select>
                        </div>
                    </div>
                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                        {sortedAndFilteredCampaigns.map(campaign => ( <CampaignCard key={campaign.id} campaign={campaign} onSelect={onCampaignSelect} onLike={onLike} isLiked={likedItems.some(item => item.id === campaign.id)} /> ))}
                    </div>
                </div>
            );
        };

        function DashboardScreen({ pledgedItems, waitingListItems, likedItems, productionSteps, activeView, onNavigate, onCampaignSelect, onLike }) {
            const renderContent = () => {
                switch(activeView) {
                    case 'My MePont':
                        return <PledgedItemsView items={pledgedItems} productionSteps={productionSteps} />;
                    case 'Waiting List':
                        return <ItemGridView items={waitingListItems} onCampaignSelect={onCampaignSelect} onLike={onLike} likedItems={likedItems} emptyMessage="Your waiting list is empty." />;
                    case 'Liked':
                        return <ItemGridView items={likedItems} onCampaignSelect={onCampaignSelect} onLike={onLike} likedItems={likedItems} emptyMessage="You haven't liked any items yet." />;
                    default:
                        return <PledgedItemsView items={pledgedItems} productionSteps={productionSteps} />;
                }
            }

            return (
                <div className="max-w-4xl mx-auto p-4 sm:p-6 lg:p-8">
                    <header className="mb-8">
                        <h1 className="text-3xl font-bold tracking-tight text-gray-900">{activeView.replace('My MePont', 'My Pledges')}</h1>
                    </header>
                    <div className="mb-6 border-b border-gray-200">
                        <div className="flex space-x-2 sm:space-x-4">
                            <button onClick={() => onNavigate('Dashboard', 'My MePont')} className={`py-2 px-1 sm:px-2 font-semibold text-sm sm:text-base ${activeView === 'My MePont' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>My Pledges</button>
                            <button onClick={() => onNavigate('Dashboard', 'Waiting List')} className={`py-2 px-1 sm:px-2 font-semibold text-sm sm:text-base ${activeView === 'Waiting List' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Waiting List</button>
                            <button onClick={() => onNavigate('Dashboard', 'Liked')} className={`py-2 px-1 sm:px-2 font-semibold text-sm sm:text-base ${activeView === 'Liked' ? 'text-blue-600 border-b-2 border-blue-600' : 'text-gray-500'}`}>Liked</button>
                        </div>
                    </div>
                    {renderContent()}
                </div>
            );
        }

        const PledgedItemsView = ({ items, productionSteps }) => {
            if (items.length === 0) {
                return <div className="text-center py-20 bg-white rounded-lg shadow"><p className="text-gray-500">You haven't pledged for any items yet.</p></div>;
            }
            return (
                <div className="space-y-6">
                    {items.map((item, index) => (
                        <div key={index} className="bg-white p-4 sm:p-6 rounded-lg shadow-md">
                            <div className="flex flex-col sm:flex-row items-start sm:items-center space-y-4 sm:space-y-0 sm:space-x-6 mb-4">
                                <img src={item.heroImage} alt={item.name} className="w-24 h-32 object-cover rounded-md flex-shrink-0" />
                                <div className="flex-grow">
                                    <p className="font-bold text-lg text-gray-900">{item.name}</p>
                                    <p className="text-sm text-gray-600">Size: {item.size}</p>
                                    <p className="text-sm text-gray-600">Price: €{item.price}</p>
                                </div>
                            </div>
                            <div>
                                <h4 className="font-semibold mb-4 text-sm text-gray-800">Production Status</h4>
                                <div className="relative flex items-center justify-between w-full">
                                    <div className="absolute left-0 top-1/2 w-full h-0.5 bg-gray-200 transform -translate-y-1/2"></div>
                                    <div 
                                        className="absolute left-0 top-1/2 h-0.5 bg-blue-600 transform -translate-y-1/2 transition-all duration-500" 
                                        style={{width: `${(productionSteps.indexOf(item.productionStatus) / (productionSteps.length - 1)) * 100}%`}}>
                                    </div>
                                    {productionSteps.map((step) => {
                                        const currentStepIndex = productionSteps.indexOf(item.productionStatus);
                                        const stepIndex = productionSteps.indexOf(step);
                                        const isCompleted = stepIndex <= currentStepIndex;
                                        return (
                                            <div key={step} className="relative z-10 flex flex-col items-center">
                                                <div className={`w-5 h-5 rounded-full flex items-center justify-center transition-colors duration-300 ${isCompleted ? 'bg-blue-600' : 'bg-gray-200 border-2 border-white'}`}>
                                                    {isCompleted && <svg xmlns="http://www.w3.org/2000/svg" width="10" height="10" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="4" strokeLinecap="round" strokeLinejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>}
                                                </div>
                                                <p className={`text-xs text-center mt-2 w-20 transition-colors duration-300 ${isCompleted ? 'font-semibold text-blue-600' : 'text-gray-500'}`}>{step}</p>
                                            </div>
                                        );
                                    })}
                                </div>
                            </div>
                        </div>
                    ))}
                </div>
            );
        };

        const ItemGridView = ({ items, onCampaignSelect, onLike, likedItems, emptyMessage }) => {
             if (items.length === 0) {
                return <div className="text-center py-20 bg-white rounded-lg shadow"><p className="text-gray-500">{emptyMessage}</p></div>;
            }
            return (
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-6">
                    {items.map(item => (
                        <CampaignCard key={item.id} campaign={item} onSelect={onCampaignSelect} onLike={onLike} isLiked={likedItems.some(li => li.id === item.id)} />
                    ))}
                </div>
            );
        };

        // --- MODALS ---
        function CampaignDetailModal({ campaign, onPledge, onBack, onLike, isLiked, hasPurchased, onCommentSubmit, onReviewSubmit, onShow3D, onShowMedia, isNestedModalOpen, onAddToWaitingList, isOnWaitingList }) {
            const [show, setShow] = useState(false);
            const [islandNotification, setIslandNotification] = useState({ key: 0, message: '' });

            const showIslandNotification = (message) => {
                setIslandNotification({ key: Date.now(), message });
            };
            
            useEffect(() => {
                const timer = setTimeout(() => setShow(true), 10);
                document.body.style.overflow = 'hidden';
                return () => {
                    clearTimeout(timer);
                    document.body.style.overflow = 'auto';
                };
            }, []);

            const handleClose = () => {
                setShow(false);
                setTimeout(onBack, 300);
            };
            
            return (
                <div 
                    className={`fixed inset-0 z-50 flex items-center justify-center p-0 sm:p-4 lg:p-8 transition-opacity duration-300 ease-in-out ${show ? 'opacity-100' : 'opacity-0'}`} 
                    onClick={handleClose}
                >
                    <div 
                        className={`w-full h-full bg-white/80 backdrop-blur-xl shadow-2xl transform transition-all duration-300 ease-in-out relative flex flex-col sm:rounded-2xl sm:overflow-hidden ${show ? 'scale-100 opacity-100' : 'scale-95 opacity-0'} ${isNestedModalOpen ? 'blur-background' : ''}`}
                        onClick={(e) => e.stopPropagation()}
                    >
                        <CampaignDetailContent 
                            campaign={campaign} 
                            onPledge={() => onPledge(campaign.id, null, showIslandNotification)} // Size will be handled in pledge modal
                            onLike={() => onLike(campaign.id, showIslandNotification)} 
                            isLiked={isLiked} 
                            hasPurchased={hasPurchased} 
                            onCommentSubmit={(id, text) => onCommentSubmit(id, text, showIslandNotification)} 
                            onReviewSubmit={(id, review) => onReviewSubmit(id, review, showIslandNotification)} 
                            onShow3D={onShow3D} 
                            onShowMedia={onShowMedia} 
                            onAddToWaitingList={() => onAddToWaitingList(campaign.id, showIslandNotification)} 
                            isOnWaitingList={isOnWaitingList}
                            islandNotification={islandNotification}
                            onClose={handleClose}
                        />
                    </div>
                </div>
            );
        };
        
        function CampaignDetailContent({ campaign, onPledge, onLike, isLiked, hasPurchased, onCommentSubmit, onReviewSubmit, onShow3D, onShowMedia, onAddToWaitingList, isOnWaitingList, islandNotification, onClose }) {
            const [selectedSize, setSelectedSize] = useState(campaign.sizeGuide.sizes && Object.keys(campaign.sizeGuide.sizes).length > 0 ? Object.keys(campaign.sizeGuide.sizes)[0] : null);
            
            const mediaItems = [ ...[...new Set([campaign.heroImage, ...campaign.images])].map(img => ({ type: 'image', url: img, thumbnail: img })), ...(campaign.video ? [{ type: 'video', url: campaign.video.url, thumbnail: campaign.video.thumbnail }] : []) ];
            const [currentMediaIndex, setCurrentMediaIndex] = useState(0);
            const [isFading, setIsFading] = useState(false);
            
            const touchStartX = useRef(0);
            const touchEndX = useRef(0);
            const hasSwiped = useRef(false);

            const contentRef = useRef(null);
            const sectionRefs = {
                details: useRef(null),
                care: useRef(null),
                price: useRef(null),
                size: useRef(null),
                community: useRef(null),
            };

            const handleTouchStart = (e) => {
                touchStartX.current = e.targetTouches[0].clientX;
                hasSwiped.current = false;
            };
            const handleTouchMove = (e) => {
                touchEndX.current = e.targetTouches[0].clientX;
                if (Math.abs(touchStartX.current - touchEndX.current) > 10) {
                    hasSwiped.current = true;
                }
            };
            const handleTouchEnd = () => {
                if (!hasSwiped.current) return;
                const swipeDistance = touchStartX.current - touchEndX.current;
                if (Math.abs(swipeDistance) > 50) {
                    const direction = swipeDistance > 0 ? 1 : -1;
                    const newIndex = (currentMediaIndex + direction + mediaItems.length) % mediaItems.length;
                    if (newIndex !== currentMediaIndex) {
                        setIsFading(true);
                        setTimeout(() => {
                            setCurrentMediaIndex(newIndex);
                            setIsFading(false);
                        }, 150);
                    }
                }
            };
            
            const handleMediaClick = (index) => {
                if (!hasSwiped.current) {
                    onShowMedia(index);
                }
            };

            const MainActions = () => {
                const actionButtonClass = "font-bold py-3 sm:py-4 rounded-xl shadow-lg transition-all flex items-center justify-center space-x-2 w-full disabled:opacity-50 disabled:cursor-not-allowed";
                switch(campaign.stage) {
                    case 'DESIGN': return ( <button onClick={onLike} className={`${actionButtonClass} ${isLiked ? 'bg-pink-600 text-white' : 'bg-white text-pink-600 border-2 border-pink-600'}`}> <HeartIcon className="w-6 h-6" isFilled={isLiked} /> <span>{isLiked ? 'Liked' : 'Like to Fund Sampling'}</span> </button> );
                    case 'SAMPLING': return ( <button onClick={onAddToWaitingList} className={`${actionButtonClass} ${isOnWaitingList ? 'bg-gray-400 text-white' : 'bg-cyan-600 text-white'}`}> {isOnWaitingList ? 'On Waiting List' : 'Notify Me When Live'} </button> );
                    case 'PRE_ORDER': 
                        return (
                            <div className="flex items-stretch gap-3 w-full">
                                <button onClick={onPledge} className={`flex-grow ${actionButtonClass} bg-blue-600 text-white hover:bg-blue-700`}>
                                    Pledge Now for €{campaign.price}
                                </button>
                                <div className="flex items-center justify-center text-sm font-bold text-gray-800 bg-gray-200/80 px-4 rounded-xl whitespace-nowrap">
                                    R{campaign.productionRound}
                                </div>
                            </div>
                        );
                    case 'CONFIRMED':
                        return <button disabled className={`${actionButtonClass} bg-green-600 text-white`}> <CheckCircleIcon className="w-6 h-6" /> <span>Fully Funded!</span> </button>;
                    default: return null;
                }
            }

            const TopSection = () => (
                 <div className="p-5 lg:p-6 border-b border-gray-200">
                    {campaign.stage === 'PRE_ORDER' && ( campaign.preOrderDetails.fundingType === 'COMBINED' ? ( <> <div className="w-full bg-gray-200 rounded-full h-2.5"> <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${(Object.values(campaign.preOrderDetails.sizes).reduce((acc, size) => acc + size.funded, 0) / campaign.preOrderDetails.overallMoq) * 100}%` }}></div> </div> <div className="flex justify-between items-center text-sm text-gray-600 mt-2"> <span>{Object.values(campaign.preOrderDetails.sizes).reduce((acc, size) => acc + size.funded, 0)} / {campaign.preOrderDetails.overallMoq} Funded</span> <span className="font-semibold">{campaign.preOrderDetails.daysLeft} days left</span> </div> </> ) : ( <> <div className="flex justify-between items-center text-sm text-gray-600 mb-4"> <span className="font-semibold">Funding Ends in {campaign.preOrderDetails.daysLeft} days</span> <span className="font-bold text-lg">€{campaign.price}</span> </div> <div className="space-y-3 mb-4"> <h4 className="font-semibold text-sm text-gray-800">Fund each size independently:</h4> {Object.entries(campaign.preOrderDetails.sizes).map(([size, data]) => { const progress = (data.funded / data.moq) * 100; const isFunded = progress >= 100; return ( <div key={size}> <div className={`flex justify-between items-center mb-1 text-xs ${isFunded ? 'text-green-600 font-semibold' : 'text-gray-600'}`}> <span className="font-semibold">{size}</span> <span>{data.funded} / {data.moq}</span> </div> <div className="w-full bg-gray-200 rounded-full h-2"> <div className={`${isFunded ? 'bg-green-600' : 'bg-blue-600'} h-2 rounded-full`} style={{ width: `${Math.min(progress, 100)}%` }}></div> </div> </div> ); })} </div> </> ) )}
                    {campaign.stage === 'DESIGN' && ( <> <div className="w-full bg-gray-200 rounded-full h-2"> <div className="bg-pink-500 h-2 rounded-full" style={{ width: `${(campaign.likes / campaign.targetLikes) * 100}%` }}></div> </div> <div className="flex justify-between items-center text-sm text-gray-600 mt-2"> <span>{campaign.likes} / {campaign.targetLikes} likes to sample</span> </div> </> )}
                    {campaign.stage === 'SAMPLING' && ( <div className="bg-cyan-50 text-cyan-800 p-4 rounded-lg text-center"> <p className="font-semibold">Sample in Progress</p> <p className="text-sm">Pre-orders will open soon.</p> </div> )}
                    {campaign.stage === 'CONFIRMED' && ( <div className="bg-green-50 text-green-800 p-4 rounded-lg text-center flex items-center justify-center gap-2"> <CheckCircleIcon className="w-5 h-5" /> <p className="font-semibold">Funding Goal Reached!</p> <p className="text-sm">Production starting soon.</p> </div> )}
                </div>
            );

            return (
                <div className="w-full h-full lg:grid lg:grid-cols-5 overflow-hidden">
                    {/* Media Column (Left) */}
                    <div className="lg:col-span-3 h-full p-4 hidden lg:flex flex-col gap-4 overflow-hidden">
                        <div className="flex-1 relative">
                            <button className="w-full h-full rounded-lg overflow-hidden" onClick={() => onShowMedia(currentMediaIndex)}>
                                {mediaItems[currentMediaIndex].type === 'video' ? (
                                    <video key={mediaItems[currentMediaIndex].url} src={mediaItems[currentMediaIndex].url} autoPlay loop muted playsInline className="w-full h-full object-cover bg-black"></video>
                                ) : (
                                    <img src={mediaItems[currentMediaIndex].url} alt="Product view" className="w-full h-full object-cover" />
                                )}
                            </button>
                            {campaign.has3D && (
                                <button 
                                    onClick={(e) => { e.stopPropagation(); onShow3D(); }} 
                                    className="absolute bottom-4 right-4 bg-white/80 backdrop-blur-sm text-gray-800 font-semibold py-2 px-3 rounded-full flex items-center gap-2 shadow-lg hover:bg-white transition-colors"
                                >
                                    <CubeIcon className="w-5 h-5" />
                                    <span>3D</span>
                                </button>
                            )}
                        </div>
                         <div className="flex-shrink-0 flex justify-center items-center space-x-2">
                            {mediaItems.map((media, index) => (
                                <button key={index} onClick={() => setCurrentMediaIndex(index)} className={`w-16 h-20 flex-shrink-0 rounded-md overflow-hidden border-2 relative ${currentMediaIndex === index ? 'border-blue-600' : 'border-transparent'}`}>
                                    <img src={media.thumbnail} alt={media.type} className="w-full h-full object-cover" />
                                    {media.type === 'video' && <div className="absolute inset-0 bg-black/30 flex items-center justify-center"><PlayIcon className="w-6 h-6 text-white" /></div>}
                                </button>
                            ))}
                        </div>
                    </div>

                    {/* Details Column (Right) */}
                    <div className="lg:col-span-2 h-full flex flex-col">
                        <div className="flex-1 relative">
                            <div ref={contentRef} className="absolute inset-0 overflow-y-auto scrollbar-hide">
                                 {/* Mobile Media */}
                                <div className="lg:hidden">
                                    <div 
                                        className={`relative aspect-[4/5] mb-2 transition-opacity duration-150 ${isFading ? 'opacity-0' : 'opacity-100'}`}
                                        onTouchStart={handleTouchStart}
                                        onTouchMove={handleTouchMove}
                                        onTouchEnd={handleTouchEnd}
                                    >
                                        <button className="w-full h-full" onClick={() => handleMediaClick(currentMediaIndex)}>
                                        {mediaItems[currentMediaIndex].type === 'video' ? (
                                            <video key={mediaItems[currentMediaIndex].url} src={mediaItems[currentMediaIndex].url} controls className="w-full h-full object-cover bg-black"></video>
                                        ) : (
                                            <img src={mediaItems[currentMediaIndex].url} alt="Product view" className="w-full h-full object-cover" />
                                        )}
                                        </button>
                                        {campaign.has3D && (
                                            <button 
                                                onClick={(e) => { e.stopPropagation(); onShow3D(); }} 
                                                className="absolute bottom-4 right-4 bg-white/80 backdrop-blur-sm text-gray-800 font-semibold py-2 px-3 rounded-full flex items-center gap-2 shadow-lg hover:bg-white transition-colors"
                                            >
                                                <CubeIcon className="w-5 h-5" />
                                                <span>3D</span>
                                            </button>
                                        )}
                                    </div>
                                    <div className="flex justify-center items-center space-x-2">
                                        {mediaItems.map((_, index) => (
                                            <div key={index} className={`w-2 h-2 rounded-full ${currentMediaIndex === index ? 'bg-blue-600' : 'bg-gray-300'}`}></div>
                                        ))}
                                    </div>
                                </div>
                                
                                {/* Common Details */}
                                <div className="p-5 lg:p-6 lg:pt-24"> {/* Add padding for sticky island */}
                                    <div className="flex justify-between items-center">
                                        <p className="text-sm text-gray-800">{campaign.designer}</p>
                                    </div>
                                    <h2 className="text-3xl font-bold text-gray-900">{campaign.name}</h2>
                                </div>
                                <TopSection />

                                <div className="px-5 lg:px-6 pb-24 space-y-8">
                                    <ContentSection id="details" title="Details" ref={sectionRefs.details}>
                                        <p className="text-gray-700 mb-6">{campaign.details}</p>
                                        {campaign.manufacturer && campaign.manufacturer.country !== 'TBD' && ["Austria", "Belgium", "Bulgaria", "Croatia", "Cyprus", "Czech Republic", "Denmark", "Estonia", "Finland", "France", "Germany", "Greece", "Hungary", "Ireland", "Italy", "Latvia", "Lithuania", "Luxembourg", "Malta", "Netherlands", "Poland", "Portugal", "Romania", "Slovakia", "Slovenia", "Spain", "Sweden"].includes(campaign.manufacturer.country) && (
                                            <div className="mb-6 bg-blue-50 border border-blue-200 p-4 rounded-lg flex items-center gap-4">
                                                <EUFlagIcon />
                                                <div>
                                                    <h4 className="font-bold text-blue-900">Proudly Made in the EU</h4>
                                                    <p className="text-sm text-blue-800">This product is manufactured in {campaign.manufacturer.country}, supporting local craftsmanship and ensuring high labor standards.</p>
                                                </div>
                                            </div>
                                        )}
                                        {campaign.designerUpdates && campaign.designerUpdates.length > 0 && (
                                            <div className="mb-6">
                                                <h3 className="font-bold text-md mb-3 text-gray-800">Designer's Updates</h3>
                                                <div className="space-y-4">
                                                    {campaign.designerUpdates.map((update, index) => (
                                                        <div key={index} className="relative pl-6 border-l-2 border-gray-200">
                                                            <div className="absolute -left-[9px] top-1 w-4 h-4 bg-white border-2 border-gray-300 rounded-full"></div>
                                                            <p className="text-xs text-gray-500">{update.date}</p>
                                                            <p className="font-semibold text-gray-800">{update.title}</p>
                                                            <p className="text-sm text-gray-600">{update.text}</p>
                                                        </div>
                                                    ))}
                                                </div>
                                            </div>
                                        )}
                                    </ContentSection>

                                    <ContentSection id="care" title="Care & Composition" ref={sectionRefs.care}>
                                        <div className="bg-gray-100/80 p-4 rounded-lg space-y-2 text-sm">
                                            <h5 className="font-bold mb-2 text-gray-800">Composition</h5>
                                            <p className="text-gray-700">{campaign.garmentCare.composition}</p>
                                        </div>
                                        <div className="mt-4 bg-gray-100/80 p-4 rounded-lg space-y-2 text-sm">
                                            <h5 className="font-bold mb-2 text-gray-800">Care Instructions</h5>
                                            <ul className="list-disc list-inside text-gray-700">
                                                {campaign.garmentCare.instructions.map((instruction, index) => <li key={index}>{instruction}</li>)}
                                            </ul>
                                        </div>
                                    </ContentSection>

                                    <ContentSection id="price" title="Price Breakdown" ref={sectionRefs.price}>
                                        <p className="text-gray-700 mb-4 text-sm">We believe in radical transparency. Here's the true cost of making this garment.</p>
                                        <div className="space-y-3 mb-6">
                                            {Object.entries(campaign.priceBreakdown).map(([key, value]) => {
                                                const percentage = (value / campaign.price) * 100;
                                                return (
                                                    <div key={key}>
                                                        <div className="flex justify-between text-sm mb-1">
                                                            <span className="capitalize text-gray-600">{key}</span>
                                                            <span className="font-semibold text-gray-900">€{value.toFixed(2)}</span>
                                                        </div>
                                                        <div className="w-full bg-gray-200 rounded-full h-2">
                                                            <div className="bg-blue-500 h-2 rounded-full" style={{width: `${percentage}%`}}></div>
                                                        </div>
                                                    </div>
                                                )
                                            })}
                                        </div>
                                        <div className="border-t border-gray-200 pt-4">
                                            <div className="flex justify-between text-sm mb-2">
                                                <span className="text-gray-600">True Cost</span>
                                                <span className="font-semibold text-gray-900">€{Object.values(campaign.priceBreakdown).reduce((sum, val) => sum + val, 0).toFixed(2)}</span>
                                            </div>
                                            <div className="flex justify-between text-md font-bold text-gray-900">
                                                <span>Our Price</span>
                                                <span>€{campaign.price.toFixed(2)}</span>
                                            </div>
                                        </div>
                                        <div className="mt-6 bg-blue-50 border border-blue-200 p-3 rounded-lg text-sm text-blue-800">
                                            <p><strong>Please Note:</strong> The final price at checkout will include an estimate for shipping and any applicable import duties based on your delivery address. This will be clearly displayed before you confirm your pledge.</p>
                                        </div>
                                    </ContentSection>

                                    <ContentSection id="size" title="Size & Fit" ref={sectionRefs.size}>
                                        <p className="text-gray-700 mb-4">{campaign.sizeGuide.fitDetails}</p>
                                        {selectedSize ? (
                                            <>
                                            <div className="flex space-x-2 mb-4 overflow-x-auto pb-2 scrollbar-hide">
                                                {Object.keys(campaign.sizeGuide.sizes).map(size => (
                                                    <button key={size} onClick={() => setSelectedSize(size)} className={`px-3 py-1.5 rounded-lg border-2 transition-all text-sm font-semibold ${selectedSize === size ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-200'}`}>
                                                        {size}
                                                    </button>
                                                ))}
                                            </div>
                                            <div className="bg-gray-100/80 p-4 rounded-lg space-y-2 text-sm">
                                                <h5 className="font-bold mb-2 text-gray-800">Measurements for Size {selectedSize}</h5>
                                                {Object.entries(campaign.sizeGuide.sizes[selectedSize]).map(([key, value]) => (
                                                    <div key={key} className="flex justify-between">
                                                        <span className="text-gray-600">{key}</span>
                                                        <span className="font-semibold text-gray-900">{value}</span>
                                                    </div>
                                                ))}
                                            </div>
                                            </>
                                        ) : <p className="text-gray-500 text-sm">Size guide coming soon.</p>}
                                    </ContentSection>

                                    <ContentSection id="community" title="Community" ref={sectionRefs.community}>
                                        <h4 className="font-bold text-md mb-3 text-gray-800">Reviews</h4>
                                        {campaign.reviews.length > 0 ? (
                                            <div className="space-y-4">
                                                {campaign.reviews.map((review, index) => (
                                                    <div key={index} className="border-b border-gray-200 pb-4 last:border-b-0">
                                                        <div className="flex items-center mb-1">
                                                            {[...Array(5)].map((_, i) => <StarIcon key={i} className="w-4 h-4 text-yellow-500" isFilled={i < review.rating} />)}
                                                            <span className="ml-2 font-bold text-gray-800">{review.user}</span>
                                                        </div>
                                                        <p className="text-gray-700">{review.comment}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <p className="text-gray-500 text-sm py-2">No reviews yet.</p>
                                        )}
                                        {hasPurchased && <ReviewForm campaignId={campaign.id} onSubmit={onReviewSubmit} />}
                                        
                                        <h4 className="font-bold text-md mt-6 mb-3 text-gray-800">Comments</h4>
                                        {campaign.comments.length > 0 ? (
                                            <div className="space-y-4">
                                                {campaign.comments.map((comment, index) => (
                                                    <div key={index} className="border-b border-gray-200 pb-4 last:border-b-0">
                                                        <p className="font-bold text-sm text-gray-800">{comment.user}</p>
                                                        <p className="text-gray-700">{comment.comment}</p>
                                                    </div>
                                                ))}
                                            </div>
                                        ) : (
                                            <p className="text-gray-500 text-sm py-2">No comments yet. Be the first!</p>
                                        )}
                                        <CommentForm campaignId={campaign.id} onSubmit={onCommentSubmit} />
                                    </ContentSection>
                                </div>
                            </div>
                            <div className="absolute top-0 left-0 right-0 p-4 z-20">
                                <div className="max-w-md mx-auto">
                                    <DetailIsland 
                                        campaignName={campaign.name}
                                        designerName={campaign.designer}
                                        sectionRefs={sectionRefs}
                                        containerRef={contentRef}
                                        notification={islandNotification}
                                        onClose={onClose}
                                    />
                                </div>
                            </div>
                        </div>
                        {/* Sticky CTA Bar */}
                        <div className="flex-shrink-0 p-4 bg-white/80 backdrop-blur-sm border-t border-gray-200">
                            <MainActions />
                        </div>
                    </div>
                </div>
            );
        };

        const ContentSection = React.forwardRef(({ id, title, children }, ref) => (
            <div id={id} ref={ref} className="scroll-mt-24">
                <h3 className="text-2xl font-bold text-gray-900 mb-4">{title}</h3>
                {children}
            </div>
        ));

        function PledgeModal({ campaign, onClose, onPledge }) {
            const [show, setShow] = useState(false);
            const [selectedSize, setSelectedSize] = useState(Object.keys(campaign.preOrderDetails.sizes)[0]);
            const isCombinedFunding = campaign.preOrderDetails.fundingType === 'COMBINED';
            useEffect(() => { const timer = setTimeout(() => setShow(true), 10); return () => clearTimeout(timer); }, []);
            const handleClose = () => { setShow(false); setTimeout(onClose, 300); };
            let combinedProgress = 0; let totalFunded = 0;
            if (isCombinedFunding) { totalFunded = Object.values(campaign.preOrderDetails.sizes).reduce((acc, size) => acc + size.funded, 0); combinedProgress = campaign.preOrderDetails.overallMoq > 0 ? (totalFunded / campaign.preOrderDetails.overallMoq) * 100 : 0; }
            return (
                <div className={`fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out ${show ? 'opacity-100' : 'opacity-0'}`} onClick={handleClose}>
                    <div className={`bg-white rounded-2xl shadow-2xl w-full max-w-sm p-6 relative transform transition-all duration-300 ease-in-out ${show ? 'opacity-100 scale-100' : 'opacity-0 scale-95'}`} onClick={(e) => e.stopPropagation()}>
                        <button onClick={handleClose} className="absolute top-4 right-4 text-gray-400 hover:text-gray-600"> <XIcon className="w-6 h-6" /> </button>
                        <h2 className="font-bold text-2xl mb-2">{campaign.name}</h2>
                        <p className="text-lg text-gray-600 mb-6">€{campaign.price}</p>
                        {isCombinedFunding && ( <div className="mb-4"> <h3 className="font-semibold text-sm mb-2">Overall Funding Progress</h3> <div className="w-full bg-gray-200 rounded-full h-2.5"> <div className="bg-blue-600 h-2.5 rounded-full" style={{ width: `${combinedProgress}%` }}></div> </div> <div className="flex justify-between items-center text-xs text-gray-600 mt-1"> <span>{totalFunded} / {campaign.preOrderDetails.overallMoq} Funded</span> <span className="font-semibold">{campaign.preOrderDetails.daysLeft} days left</span> </div> </div> )}
                        <div className="mb-4"> <h3 className="font-semibold text-sm mb-3">{isCombinedFunding ? 'Pledges by Size' : 'Funding Progress by Size'}</h3> <div className="space-y-3"> {Object.entries(campaign.preOrderDetails.sizes).map(([size, data]) => { if (isCombinedFunding) { return ( <div key={size} className="flex justify-between items-center text-sm py-1"> <span className="font-medium text-gray-800">{size}</span> <span className="text-gray-600 font-semibold">{data.funded} pledged</span> </div> ) } const moq = data.moq; const progress = moq ? (data.funded / moq) * 100 : 0; const isFunded = moq && progress >= 100; return ( <div key={size}> <div className={`flex justify-between items-center mb-1 text-xs ${isFunded ? 'text-green-600 font-semibold' : 'text-gray-600'}`}> <span className="font-semibold">{size}</span> {moq && <span>{data.funded} / {moq}</span>} </div> {moq && <div className="w-full bg-gray-200 rounded-full h-2"> <div className={`${isFunded ? 'bg-green-600' : 'bg-blue-600'} h-2 rounded-full`} style={{ width: `${Math.min(progress, 100)}%` }}></div> </div>} </div> ); })} </div> </div>
                        <div className="mb-6"> <h3 className="font-semibold text-sm mb-2">Select Size to Pledge For</h3> <div className="flex space-x-2 overflow-x-auto pb-2 scrollbar-hide"> {Object.keys(campaign.preOrderDetails.sizes).map(size => ( <button key={size} onClick={() => setSelectedSize(size)} className={`px-3 py-1.5 rounded-lg border-2 transition-all text-sm font-semibold ${selectedSize === size ? 'bg-blue-600 text-white border-blue-600' : 'bg-white text-gray-700 border-gray-200'}`}> {size} </button> ))} </div> </div>
                        <div className="bg-blue-50 border-l-4 border-blue-400 p-3 rounded-r-lg mb-6"> <p className="text-sm text-blue-800">Your card will only be charged if the funding goal is met.</p> </div>
                        <button onClick={() => onPledge(campaign, selectedSize)} className="w-full bg-blue-600 text-white font-bold py-3 rounded-xl shadow-lg hover:bg-blue-700 transition-all"> Confirm Pledge for Size {selectedSize} </button>
                    </div>
                </div>
            );
        };

        function ThreeDModal({ onClose }) {
            const [show, setShow] = useState(false);
            useEffect(() => { const timer = setTimeout(() => setShow(true), 10); return () => clearTimeout(timer); }, []);
            const handleClose = () => { setShow(false); setTimeout(onClose, 300); };
            return (
                <div className={`fixed inset-0 bg-black/60 z-[60] flex items-center justify-center p-4 transition-opacity duration-300 ease-in-out ${show ? 'opacity-100' : 'opacity-0'}`} onClick={handleClose}>
                    <div className={`w-full h-full max-w-4xl max-h-[80vh] bg-slate-200 rounded-2xl shadow-2xl relative transform transition-all duration-300 ease-in-out overflow-hidden ${show ? 'opacity-100 scale-100' : 'opacity-0 scale-95'}`} onClick={(e) => e.stopPropagation()}>
                        <button onClick={handleClose} className="absolute top-4 right-4 text-gray-800 bg-white/50 rounded-full p-2 hover:bg-white z-10"> <XIcon className="w-6 h-6" /> </button>
                        <ThreeDViewer />
                    </div>
                </div>
            );
        }

        function MediaViewerModal({ campaign, startIndex, onClose }) {
            const mediaItems = [ ...[...new Set([campaign.heroImage, ...campaign.images])].map(img => ({ type: 'image', url: img, thumbnail: img })), ...(campaign.video ? [{ type: 'video', url: campaign.video.url, thumbnail: campaign.video.thumbnail }] : []) ];
            const [currentIndex, setCurrentIndex] = useState(startIndex);
            const [show, setShow] = useState(false);

            useEffect(() => {
                const timer = setTimeout(() => setShow(true), 10);
                return () => clearTimeout(timer);
            }, []);

            const handleClose = () => {
                setShow(false);
                setTimeout(onClose, 300);
            };

            return (
                <div className={`fixed inset-0 bg-black/80 z-[60] flex flex-col items-center justify-center p-4 transition-opacity duration-300 ease-in-out ${show ? 'opacity-100' : 'opacity-0'}`} onClick={handleClose}>
                    <button onClick={handleClose} className="absolute top-4 right-4 text-white bg-black/30 rounded-full p-2 hover:bg-black/50 z-10">
                        <XIcon className="w-6 h-6" />
                    </button>
                    <div className={`w-full h-full max-w-5xl max-h-[80vh] flex items-center justify-center transform transition-all duration-300 ease-in-out ${show ? 'opacity-100 scale-100' : 'opacity-0 scale-95'}`} onClick={(e) => e.stopPropagation()}>
                        {mediaItems[currentIndex].type === 'video' ? (
                            <video key={mediaItems[currentIndex].url} src={mediaItems[currentIndex].url} controls autoPlay className="max-w-full max-h-full object-contain rounded-lg"></video>
                        ) : (
                            <img src={mediaItems[currentIndex].url} alt="Full screen product view" className="max-w-full max-h-full object-contain rounded-lg" />
                        )}
                    </div>
                    <div className={`mt-4 flex space-x-2 overflow-x-auto scrollbar-hide transform transition-all duration-300 ease-in-out ${show ? 'opacity-100' : 'opacity-0'}`} onClick={(e) => e.stopPropagation()}>
                        {mediaItems.map((media, index) => (
                            <button key={index} onClick={() => setCurrentIndex(index)} className={`w-16 h-20 flex-shrink-0 rounded-md overflow-hidden border-2 relative ${currentIndex === index ? 'border-white' : 'border-transparent'}`}>
                                <img src={media.thumbnail} alt={media.type} className="w-full h-full object-cover" />
                                {media.type === 'video' && <div className="absolute inset-0 bg-black/30 flex items-center justify-center"><PlayIcon className="w-6 h-6 text-white" /></div>}
                            </button>
                        ))}
                    </div>
                </div>
            );
        }

        // --- REUSABLE UI COMPONENTS ---
        function CommentForm({ campaignId, onSubmit }) {
            const [comment, setComment] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if(comment.trim()) {
                    onSubmit(campaignId, comment);
                    setComment('');
                }
            }
            return (
                <form onSubmit={handleSubmit} className="mt-4">
                    <textarea value={comment} onChange={(e) => setComment(e.target.value)} className="w-full p-2 border rounded-lg text-sm bg-white" placeholder="Add a comment..."></textarea>
                    <button type="submit" className="mt-2 px-4 py-2 bg-gray-800 text-white font-semibold rounded-lg text-sm hover:bg-gray-900 transition-colors">Post Comment</button>
                </form>
            );
        };

        function ReviewForm({ campaignId, onSubmit }) {
            const [rating, setRating] = useState(5);
            const [comment, setComment] = useState('');
            const handleSubmit = (e) => {
                e.preventDefault();
                if(comment.trim()) {
                    onSubmit(campaignId, { rating, comment });
                    setComment('');
                    setRating(5);
                }
            }
            return (
                <form onSubmit={handleSubmit} className="mt-6 pt-4 border-t border-gray-200">
                    <h5 className="font-bold mb-2">Write a Review</h5>
                    <div className="flex items-center mb-2">
                        {[...Array(5)].map((_, i) => <button type="button" key={i} onClick={() => setRating(i+1)}><StarIcon className={`w-6 h-6 transition-colors ${i < rating ? 'text-yellow-500' : 'text-gray-300 hover:text-yellow-400'}`} isFilled={i < rating} /></button>)}
                    </div>
                    <textarea value={comment} onChange={(e) => setComment(e.target.value)} className="w-full p-2 border rounded-lg text-sm bg-white" placeholder="Share your thoughts on the fit and quality..."></textarea>
                    <button type="submit" className="mt-2 px-4 py-2 bg-blue-600 text-white font-semibold rounded-lg text-sm hover:bg-blue-700 transition-colors">Submit Review</button>
                </form>
            );
        };

        function CampaignCard({ campaign, onSelect, onLike, isLiked }) {
            const renderCardContent = () => {
                switch (campaign.stage) {
                case 'DESIGN':
                    const likeProgress = (campaign.likes / campaign.targetLikes) * 100;
                    return (
                    <div className="p-4">
                        <p className="text-sm text-gray-800">{campaign.designer}</p>
                        <h3 className="font-bold text-xl truncate text-gray-900">{campaign.name}</h3>
                        <div className="mt-4">
                        <div className="w-full bg-gray-200/70 rounded-full h-2">
                            <div className="bg-pink-500 h-2 rounded-full" style={{ width: `${likeProgress}%` }}></div>
                        </div>
                        <div className="flex justify-between items-center text-sm text-gray-700 mt-2">
                            <span>{campaign.likes} / {campaign.targetLikes} likes</span>
                            <button onClick={(e) => { e.stopPropagation(); onLike(campaign.id); }} className={`flex items-center space-x-1 font-semibold transition-colors ${isLiked ? 'text-pink-600' : 'text-gray-500'}`}>
                            <HeartIcon className="w-4 h-4" isFilled={isLiked} />
                            <span>{isLiked ? 'Liked' : 'Like'}</span>
                            </button>
                        </div>
                        </div>
                    </div>
                    );
                case 'SAMPLING':
                    return (
                    <div className="p-4">
                        <p className="text-sm text-gray-800">{campaign.designer}</p>
                        <h3 className="font-bold text-xl truncate text-gray-900">{campaign.name}</h3>
                        <div className="mt-4 bg-cyan-50/80 text-cyan-800 p-3 rounded-lg text-center">
                        <p className="font-semibold">Sample in Progress</p>
                        <p className="text-sm">Pre-orders coming soon</p>
                        </div>
                    </div>
                    );
                case 'PRE_ORDER':
                    const { fundingType, sizes, overallMoq, daysLeft } = campaign.preOrderDetails;
                    
                    const CardStatus = () => {
                        if (fundingType === 'COMBINED') {
                            const totalFunded = Object.values(sizes).reduce((acc, size) => acc + size.funded, 0);
                            const fundProgress = overallMoq > 0 ? (totalFunded / overallMoq) * 100 : 0;
                            return (
                                <>
                                    <div className="w-full bg-gray-200/70 rounded-full h-2">
                                        <div className="bg-blue-600 h-2 rounded-full" style={{ width: `${fundProgress}%` }}></div>
                                    </div>
                                    <div className="flex justify-between text-sm text-gray-700 mt-2">
                                        <span>{Math.floor(fundProgress)}% Funded</span>
                                        <span>{daysLeft} days left</span>
                                    </div>
                                </>
                            );
                        } else {
                            const fundedSizes = Object.values(sizes).filter(s => s.funded >= s.moq).length;
                            const totalSizes = Object.keys(sizes).length;
                            return (
                                <>
                                    <div className="w-full bg-gray-200/70 rounded-full h-2">
                                         <div className="bg-green-600 h-2 rounded-full" style={{ width: `${(fundedSizes / totalSizes) * 100}%` }}></div>
                                    </div>
                                    <div className="flex justify-between text-sm text-gray-700 mt-2">
                                        <span className="font-medium">{fundedSizes} of {totalSizes} sizes funded</span>
                                        <span>{daysLeft} days left</span>
                                    </div>
                                </>
                            );
                        }
                    };

                    return (
                        <div className="p-4">
                            <div className="flex justify-between items-start">
                                <p className="text-sm text-gray-800">{campaign.designer}</p>
                                <span className="font-bold text-lg text-gray-900">€{campaign.price}</span>
                            </div>
                            <h3 className="font-bold text-xl truncate -mt-1 text-gray-900">{campaign.name}</h3>
                            <div className="mt-4">
                                <CardStatus />
                            </div>
                        </div>
                    );
                case 'CONFIRMED':
                     return (
                        <div className="p-4">
                            <p className="text-sm text-gray-800">{campaign.designer}</p>
                            <h3 className="font-bold text-xl truncate text-gray-900">{campaign.name}</h3>
                            <div className="mt-4 bg-green-50/80 text-green-800 p-3 rounded-lg text-center">
                                <p className="font-semibold">Fully Funded!</p>
                                <p className="text-sm">Production starting soon</p>
                            </div>
                        </div>
                    );
                default:
                    return null;
                }
            };

            return (
                <div onClick={() => onSelect(campaign)} className="bg-white/40 backdrop-blur-lg border border-white/50 rounded-xl shadow-lg overflow-hidden cursor-pointer transition-all duration-300 hover:scale-105 group">
                <div className="h-80 relative">
                    <img src={campaign.heroImage} alt={campaign.name} className="w-full h-full object-cover" />
                    <div className="absolute top-3 right-3 bg-white/80 backdrop-blur-sm text-xs font-bold px-3 py-1.5 rounded-full flex items-center space-x-1.5 shadow-sm">
                    <span className={
                        campaign.stage === 'DESIGN' ? 'text-pink-600' :
                        campaign.stage === 'SAMPLING' ? 'text-cyan-600' :
                        campaign.stage === 'CONFIRMED' ? 'text-green-600' :
                        'text-blue-600'
                    }>{campaign.stage.replace('_', ' ')}</span>
                    
                    {campaign.stage === 'DESIGN' && ( <> <ArrowRightIcon className="w-4 h-4 text-gray-400" /> <span className="text-gray-500">SAMPLING</span> </> )}
                    {campaign.stage === 'SAMPLING' && ( <> <ArrowRightIcon className="w-4 h-4 text-gray-400" /> <span className="text-gray-500">PRE-ORDER</span> </> )}
                    </div>
                    {campaign.stage === 'PRE_ORDER' && (
                        <div className="absolute bottom-3 left-3 bg-white/80 backdrop-blur-sm text-xs font-bold px-2 py-1 rounded-full shadow-sm">
                            Round {campaign.productionRound}
                        </div>
                    )}
                </div>
                {renderCardContent()}
                </div>
            );
        };
        
        // --- SKELETON LOADERS ---
        const CampaignCardSkeleton = () => (
            <div className="bg-white/40 rounded-xl shadow-lg overflow-hidden animate-pulse">
                <div className="h-80 bg-gray-300"></div>
                <div className="p-4">
                    <div className="h-4 bg-gray-300 rounded w-1/3 mb-2"></div>
                    <div className="h-6 bg-gray-300 rounded w-3/4 mb-4"></div>
                    <div className="h-2 bg-gray-300 rounded w-full mb-2"></div>
                    <div className="flex justify-between">
                        <div className="h-4 bg-gray-300 rounded w-1/4"></div>
                        <div className="h-4 bg-gray-300 rounded w-1/4"></div>
                    </div>
                </div>
            </div>
        );

        const HomeScreenSkeleton = () => (
            <div className="p-4 sm:p-6 lg:p-8">
                <header className="mb-8 text-center">
                    <div className="h-12 bg-gray-300 rounded w-1/2 mx-auto animate-pulse"></div>
                    <div className="h-6 bg-gray-300 rounded w-1/3 mx-auto mt-4 animate-pulse"></div>
                </header>
                <div className="mb-8">
                    <div className="flex justify-center flex-wrap gap-2">
                        {[...Array(5)].map((_, i) => <div key={i} className="h-10 bg-gray-300 rounded-full w-24 animate-pulse"></div>)}
                    </div>
                </div>
                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
                    {[...Array(8)].map((_, i) => <CampaignCardSkeleton key={i} />)}
                </div>
            </div>
        );
        
        // --- NAVIGATION ---
        function TopNavBar({ onNavigate, currentScreen, dashboardView }) {
            return (
                <header className="fixed top-0 left-0 right-0 z-40 p-2 sm:p-4">
                    <div className="max-w-7xl mx-auto flex justify-center">
                        {/* Desktop Nav */}
                        <nav className="hidden sm:flex items-center gap-2 bg-gray-900/75 backdrop-blur-lg text-white rounded-full p-2 shadow-lg">
                            <button onClick={() => onNavigate('Home')} className="text-lg font-bold px-4 py-1">MePont</button>
                            <div className="h-6 w-px bg-gray-600"></div>
                            <button onClick={() => onNavigate('Home')} className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${currentScreen === 'Home' ? 'bg-gray-700' : 'hover:bg-gray-800'}`}>Drops</button>
                            <button onClick={() => onNavigate('Dashboard', 'My MePont')} className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${currentScreen === 'Dashboard' && dashboardView === 'My MePont' ? 'bg-gray-700' : 'hover:bg-gray-800'}`}>My Pledges</button>
                            <button onClick={() => onNavigate('Dashboard', 'Waiting List')} className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${currentScreen === 'Dashboard' && dashboardView === 'Waiting List' ? 'bg-gray-700' : 'hover:bg-gray-800'}`}>Waiting List</button>
                            <button onClick={() => onNavigate('Dashboard', 'Liked')} className={`px-3 py-1 rounded-full text-sm font-medium transition-colors ${currentScreen === 'Dashboard' && dashboardView === 'Liked' ? 'bg-gray-700' : 'hover:bg-gray-800'}`}>Liked</button>
                        </nav>

                        {/* Mobile Nav */}
                        <nav className="sm:hidden flex justify-between items-center w-full max-w-sm bg-gray-900/75 backdrop-blur-lg text-white rounded-full p-2 shadow-lg">
                            <button onClick={() => onNavigate('Home')} className={`p-2 rounded-full ${currentScreen === 'Home' ? 'bg-gray-700' : ''}`}>
                                <HomeIcon className="w-6 h-6" />
                            </button>
                            <button onClick={() => onNavigate('Dashboard', 'Waiting List')} className={`p-2 rounded-full ${currentScreen === 'Dashboard' && dashboardView === 'Waiting List' ? 'bg-gray-700' : ''}`}>
                                <ListIcon className="w-6 h-6" />
                            </button>
                            <button onClick={() => onNavigate('Home')} className="text-xl font-bold">MePont</button>
                            <button onClick={() => onNavigate('Dashboard', 'Liked')} className={`p-2 rounded-full ${currentScreen === 'Dashboard' && dashboardView === 'Liked' ? 'bg-gray-700' : ''}`}>
                                <HeartIcon className="w-6 h-6" />
                            </button>
                            <button onClick={() => onNavigate('Dashboard', 'My MePont')} className={`p-2 rounded-full ${currentScreen === 'Dashboard' && dashboardView === 'My MePont' ? 'bg-gray-700' : ''}`}>
                                <UserIcon className="w-6 h-6" />
                            </button>
                        </nav>
                    </div>
                </header>
            );
        }

        const DetailIsland = ({ campaignName, designerName, sectionRefs, containerRef, notification, onClose }) => {
            const [activeSection, setActiveSection] = useState('details');
            const islandRef = useRef(null);

            const SECTIONS = [
                { id: 'details', icon: InfoIcon, label: 'Details' },
                { id: 'care', icon: ShirtIcon, label: 'Care' },
                { id: 'price', icon: TagIcon, label: 'Price' },
                { id: 'size', icon: RulerIcon, label: 'Size' },
                { id: 'community', icon: UsersIcon, label: 'Community' },
            ];

            useEffect(() => {
                const observer = new IntersectionObserver(
                    (entries) => {
                        entries.forEach(entry => {
                            if (entry.isIntersecting) {
                                setActiveSection(entry.target.id);
                            }
                        });
                    },
                    { root: containerRef.current, rootMargin: "-50% 0px -50% 0px", threshold: 0 }
                );

                const refs = sectionRefs;
                Object.values(refs).forEach(ref => {
                    if (ref.current) observer.observe(ref.current);
                });

                return () => {
                    Object.values(refs).forEach(ref => {
                        if (ref.current) observer.unobserve(ref.current);
                    });
                };
            }, [sectionRefs, containerRef]);

            const handleNavClick = (id) => {
                sectionRefs[id].current?.scrollIntoView({ behavior: 'smooth', block: 'start' });
            };

            return (
                <div 
                    ref={islandRef}
                    key={notification.key}
                    className={`
                        relative flex items-center h-14 w-full
                        bg-gray-900/75 backdrop-blur-lg rounded-2xl shadow-2xl overflow-hidden
                        ${notification.message ? 'island-notification-bg-animate' : ''}
                    `}
                >
                    {/* Default view: Title and Nav Icons */}
                    <div className={`flex items-center justify-between w-full px-2 transition-opacity duration-300 ${notification.message ? 'opacity-0' : 'opacity-100'}`}>
                        <div className="hidden lg:block mr-4 pl-2">
                            <p className="text-white font-bold truncate">{campaignName}</p>
                            <p className="text-gray-400 text-sm truncate">{designerName}</p>
                        </div>
                        <div className="flex items-center justify-center lg:justify-end flex-grow gap-x-1">
                            {SECTIONS.map(({ id, icon: Icon, label }) => (
                                <button 
                                    key={id} 
                                    onClick={() => handleNavClick(id)}
                                    className={`
                                        p-2 rounded-full transition-colors duration-200
                                        ${activeSection === id ? 'bg-blue-600 text-white' : 'text-gray-400 hover:bg-gray-700 hover:text-white'}
                                    `}
                                    aria-label={label}
                                >
                                    <Icon className="w-5 h-5" />
                                </button>
                            ))}
                        </div>
                        <div className="h-8 w-px bg-gray-600/50 mx-1"></div>
                        <button onClick={onClose} className="p-2 text-gray-400 hover:text-white hover:bg-gray-700/50 rounded-full transition-colors">
                           <XIcon className="w-5 h-5" />
                        </button>
                    </div>

                    {/* Notification view */}
                    {notification.message && (
                        <div className="absolute inset-0 flex items-center justify-center px-4">
                            <p className="text-white font-semibold whitespace-nowrap island-notification-text-animate">
                                {notification.message}
                            </p>
                        </div>
                    )}
                </div>
            );
        };

        // --- RENDER APP ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
